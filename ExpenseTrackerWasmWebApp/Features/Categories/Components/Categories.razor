@page "/categories"
@attribute [Authorize]
@rendermode InteractiveWebAssembly

@implements IDisposable
@using ExpenseTrackerSharedCL.Features.Categories
@using ExpenseTrackerSharedCL.Features.Categories.Dtos
@using ExpenseTrackerWasmWebApp.Features.Categories.Services
@using ExpenseTrackerWasmWebApp.Features.SharedKernel
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using Microsoft.AspNetCore.Components.Web
@using ExpenseTrackerWasmWebApp.Features.SharedKernel.Components
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ICategoryService CategoryService
@inject NavigationManager NavigationManager
@inject PersistentComponentState ApplicationState

<PageTitle>Categories</PageTitle>

@if(FilteredCategories != null){
    <MudContainer MaxWidth="MaxWidth.Medium">
        <MudPaper Class="pa-6 mt-6" Elevation="15">
            <MudGrid>
                <MudItem xs="12" Class="d-flex justify-center">
                    <MudText Typo="Typo.h4">Categories</MudText>
                </MudItem>
                <MudItem xs="12" Class="d-none d-md-flex justify-center gap-5 mb-4">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => OpenCategoryDialogAsync(null))" StartIcon="@Icons.Material.Filled.Add">Add</MudButton>
                </MudItem>
                <FabButton Class="d-flex d-md-none" Text="Add" IconClass="@Icons.Material.Filled.Add" OnClick="@(() => OpenCategoryDialogAsync(null))" />

                <MudItem xs="12" Class="d-none d-md-block">
                    <MudTabs Elevation="0" ApplyEffectsToContainer="true" PanelClass="pa-6" Centered="true" ActivePanelIndexChanged="PanelChanged" >
                        <MudTabPanel Text= "Expense" Icon="@Icons.Material.Filled.TrendingDown">
                            @RenderCategoryContent()
                        </MudTabPanel>
                        <MudTabPanel Text="Income" Icon="@Icons.Material.Filled.TrendingUp">
                            @RenderCategoryContent()
                        </MudTabPanel>
                    </MudTabs>
                </MudItem>
                <MudItem xs="12" Class="d-block d-md-none">
                    <MudTabs Elevation="0" ApplyEffectsToContainer="true" PanelClass="pa-6" Centered="true" ActivePanelIndexChanged="PanelChanged">
                        <MudTabPanel Text="" Icon="@Icons.Material.Filled.TrendingDown">
                            @RenderCategoryContent()
                        </MudTabPanel>
                        <MudTabPanel Text="" Icon="@Icons.Material.Filled.TrendingUp">
                            @RenderCategoryContent()
                        </MudTabPanel>
                    </MudTabs>
                </MudItem>
                    <style>
                        .mud-tab {
                            display: flex;
                            min-width: 100px !important;
                            flex-direction: column-reverse;
                        }
                    </style>
            </MudGrid>
        </MudPaper>
    </MudContainer>
}


@code {
public List<CategoryWithStatsDto> AllCategories { get; set; } = new();
public List<CategoryWithStatsDto> FilteredCategories { get; set; } = new();

private int activePanelIndex = 0;
private TransactionTypeDto transactionType = TransactionTypeDto.Expense;
private PersistingComponentStateSubscription persistingSubscription;

protected override async Task OnInitializedAsync()
{
    await base.OnInitializedAsync();

    if (!ApplicationState.TryTakeFromJson<List<CategoryWithStatsDto>>(nameof(AllCategories), out var allCategories) ||
        !ApplicationState.TryTakeFromJson<List<CategoryWithStatsDto>>(nameof(FilteredCategories), out var filteredCategories))
    {
        await RefreshPage();
    }
    else
    {
        AllCategories = allCategories;
        FilteredCategories = filteredCategories;
    }
    persistingSubscription = ApplicationState.RegisterOnPersisting(PersistCategories);
}

private Task PersistCategories()
{
    ApplicationState.PersistAsJson(nameof(AllCategories), AllCategories);
    ApplicationState.PersistAsJson(nameof(FilteredCategories), FilteredCategories);
    return Task.CompletedTask;
}

public void Dispose()
{
    persistingSubscription.Dispose();
}

    private async Task OpenCategoryDialogAsync(CategoryWithStatsDto? category)
    {
        var categoryDto = new CategoryDto();
        if(category == null)
        {
            categoryDto.Color = "#1976d2";
            categoryDto.Type = activePanelIndex == 0 ? TransactionTypeDto.Expense : TransactionTypeDto.Income;
        }
        else
        {
            categoryDto = new CategoryDto
            {
                Id = category.Id,
                Name =  category.Name,
                Color = category.Color,
                Icon = category.Icon,
                Type = category.Type
            };
        }

        var options = new DialogOptions { 
            CloseOnEscapeKey = true, 
            NoHeader=false, 
            CloseButton=true, 
            MaxWidth=MaxWidth.Medium  
        };
        var parameters = new DialogParameters<CategoryDialog>
        {
            { x => x.CategoryDto, categoryDto }
        };

        var dialog = await DialogService.ShowAsync<CategoryDialog>(title: "", parameters, options);
        var result = await dialog.Result;
        if (result != null && !result.Canceled)
        {
            await RefreshPage();
        }
    }

    private async Task ConfirmDelete(int category_id)
    {
        var options = new DialogOptions { 
            CloseOnEscapeKey = true, 
        };
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.Message,  "Are you sure you want to delete the category? " }
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>(title: "", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            var res = await CategoryService.DeleteCategoryAsync(category_id);
            if(res.IsSuccess)
            {
                Snackbar.Add("Category succesfully deleted! ", Severity.Success);
                await RefreshPage();
            }
            else if(res.Reason == FailureReason.Unauthorized)
            {
                Snackbar.Add("Session expired. Please log in again.", Severity.Error);
                NavigationManager.NavigateTo("/login");
            }
            else
            {
                Snackbar.Add(res.ErrorMessage ?? "Error deleting category!", Severity.Error);
            }
        }
    }

    private async Task PanelChanged(int index){
        activePanelIndex = index;
        transactionType = index == 0 ? TransactionTypeDto.Expense : TransactionTypeDto.Income;
        FilteredCategories = AllCategories.Where(c => c.Type == transactionType).ToList();
    }

    private async Task RefreshPage()
    {
        var result = await CategoryService.GetCategoriesWithStatsAsync();
        if (result.IsSuccess)
        {
            AllCategories = result.Data ?? new();
            FilteredCategories = AllCategories.Where(c => c.Type == transactionType).ToList();
        }
        else if(result.Reason == FailureReason.Unauthorized)
        {
            Snackbar.Add("Session expired. Please log in again.", Severity.Error);
            NavigationManager.NavigateTo("/login");
        }
        else
        {
            Snackbar.Add(result.ErrorMessage ?? "Error loading categories!", Severity.Error);
        }
    }

    private RenderFragment RenderCategoryContent() => @<text>
        @if(FilteredCategories == null || FilteredCategories.Count == 0)
        {
            <MudItem xs="12" Class="d-flex justify-center mt-4">
                <MudText Typo="Typo.h5">No @(transactionType == TransactionTypeDto.Expense ? "expense" : "income") categories found!</MudText>
            </MudItem>
        }
        else
        {
            <MudPaper Elevation="0">
                <MudGrid>
                    @foreach(var category in FilteredCategories)
                    {
                        <MudItem xs="12" md="6">
                            <CategoryCard CategoryDto="@category" OpenCategoryDialogAsync="OpenCategoryDialogAsync" ConfirmDelete="ConfirmDelete"></CategoryCard>
                        </MudItem>
                    }
                </MudGrid>
            </MudPaper>
        }
    </text>;
}
