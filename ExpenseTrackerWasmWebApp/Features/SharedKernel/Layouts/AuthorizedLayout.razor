@using ApexCharts
@using ExpenseTrackerSharedCL.Features.UserPreferences.Dtos
@using ExpenseTrackerWasmWebApp.Features.UserPreferences.Services
@using ExpenseTrackerWasmWebApp.Services
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IApexChartService ApexChartService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserPreferenceService UserPreferenceService

<MudThemeProvider @bind-IsDarkMode="@userPreferenceDto.DarkMode" Theme="_theme" />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="MudBlazor.Color.Inherit" Edge="Edge.Start"
            OnClick="@((e) => DrawerToggle())" />
        <MudSpacer />
        <MudSwitch @bind-Value="userPreferenceDto.DarkMode" Color="MudBlazor.Color.Primary" Class="ma-4" T="bool" Label="Dark Mode"
            @bind-Value:after="this.ThemeChanged" />
        <MudMenu AnchorOrigin="Origin.BottomLeft" Icon="@Icons.Material.Filled.AccountCircle">
            <ActivatorContent>
                <MudAvatar Color="MudBlazor.Color.Primary">
                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                </MudAvatar>
            </ActivatorContent>
            <ChildContent>
                <div class="px-4 py-4">
                    <MudText Typo="Typo.body2">@email</MudText>
                </div>
                <MudDivider />
                <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="Logout" Color="MudBlazor.Color.Error">Logout</MudMenuItem>
            </ChildContent>
        </MudMenu>
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" Elevation="2">
        <MudDrawerHeader>
            <MudText Typo="Typo.h5" Class="mt-1">Expense Tracker</MudText>
        </MudDrawerHeader>
        <MudNavMenu>
            <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
            <MudNavLink Href="transactions?isReoccuring=false"  Icon="@Icons.Material.Filled.CompareArrows">
                Transactions</MudNavLink>
            <MudNavLink Href="accounts" Icon="@Icons.Material.Filled.AccountBalance">Accounts
            </MudNavLink>
            <MudNavLink Href="categories" Icon="@Icons.Material.Filled.Category">Categories
            </MudNavLink>
            <MudNavLink Href="transactions?isReoccuring=true" Icon="@Icons.Material.Filled.Category">
                Reoccuring transactions
            </MudNavLink>
            <MudNavLink Href="budgets" Icon="@Icons.Material.Filled.Money">Budgets
            </MudNavLink>
        </MudNavMenu>
    </MudDrawer>
    <MudMainContent>
        @Body
    </MudMainContent>

</MudLayout>
@code {
    bool _drawerOpen = true;

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private bool IsLoggedIn = false;
    private string email = "";
    private UserPreferenceDto userPreferenceDto = new UserPreferenceDto(){DarkMode = false};

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        IsLoggedIn = user.Identity?.IsAuthenticated ?? false;
        email = user.Identity?.Name ?? "";
        if(!IsLoggedIn){
            NavigationManager.NavigateTo("login");
            return;
        }

        var result = await UserPreferenceService.GetUserPreferencesAsync();
        if(result.IsSuccess && result.Data != null)
        {
            userPreferenceDto = result.Data;
        }   
        else if(result.Reason == FailureReason.Unauthorized){
            NavigationManager.NavigateTo("login");
            return;
        }
        else{
            Snackbar.Add("Failed to load user preferences. Using default settings.", Severity.Warning);
        }
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RefreshGraphs();
        }
    }

    private async Task Logout()
    {
        if (AuthStateProvider is CustomAuthenticationStateProvider customAuth)
        {
            await customAuth.MarkUserAsLoggedOutAsync();
        }
        Snackbar.Add("You have been logged out.", Severity.Info);
        NavigationManager.NavigateTo("login");
    }


    private MudTheme _theme = new();

    private async Task ThemeChanged()
    {
        var result = await UserPreferenceService.UpdateUserPreferencesAsync(userPreferenceDto);
        if(!result.IsSuccess){
            if(result.Reason == FailureReason.Unauthorized){
                Snackbar.Add("Session expired. Please log in again.", Severity.Error);
                NavigationManager.NavigateTo("login");
                return;
            }
            else{
                Snackbar.Add("Failed to update theme preference.", Severity.Error);
                return;
            }
        }

        await RefreshGraphs();
    }

    private async Task RefreshGraphs()
    {
        await ApexChartService.SetGlobalOptionsAsync(new ApexChartBaseOptions
        {
            Debug = false,
            Theme = new Theme
            {
                Mode = userPreferenceDto.DarkMode ? Mode.Dark : Mode.Light,
                Palette = PaletteType.Palette6
            },
            Chart = new Chart
            {
                Background = "transparent"
            }
        }, true);
    }
}