@rendermode InteractiveWebAssembly
@using ExpenseTrackerSharedCL.Features.Accounts.Dtos
@using ExpenseTrackerSharedCL.Features.Accounts.Services
@using ExpenseTrackerSharedCL.Features.Categories
@using ExpenseTrackerSharedCL.Features.Categories.Dtos
@using ExpenseTrackerSharedCL.Features.Tags.Dtos
@using ExpenseTrackerSharedCL.Features.Tags.Service
@using ExpenseTrackerSharedCL.Features.Transactions.Dtos
@using ExpenseTrackerSharedCL.Features.Transactions.Services
@using ExpenseTrackerWasmWebApp.Features.Accounts.Services
@using ExpenseTrackerWasmWebApp.Features.Categories.Services
@using ExpenseTrackerWasmWebApp.Features.Tags.Services
@using ExpenseTrackerWasmWebApp.Features.Transactions.Services
@using MudBlazor
@using ExpenseTrackerWasmWebApp.Features.SharedKernel.Components
@using ExpenseTrackerSharedCL.Features.SharedKernel

@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IAccountService AccountService
@inject ICategoryService CategoryService
@inject ITagService TagService
@inject ITransactionService TransactionService
@inject NavigationManager NavigationManager

@if (!Loading)
{
    <MudDialog>
        <TitleContent>
            <MudText Typo="Typo.h5">
                @(TransactionDto.Id == null ? "Add Transaction" : "Edit Transaction")
            </MudText>
        </TitleContent>
        <DialogContent>
            <MudGrid>
                <MudItem xs="12">
                    <MudForm @ref="form">
                        @if (IsReoccuring)
                        {
                            <MudAlert Severity="Severity.Info" Elevation="0" Variant="Variant.Filled" Class="mb-4">
                                You are adding a reoccuring transaction. This transaction will be repeated based on the
                                reoccuring settings.
                            </MudAlert>

                            <MudSelect @bind-Value="TransactionDto.ReoccuranceFrequency" Label="Reoccurance type"
                                Variant="Variant.Outlined" Required="true" RequiredError="Reoccurance type is required!"
                                @bind-Value:after="this.TransactionTypeChanged">
                                @foreach (ReoccuranceFrequencyDto? item in Enum.GetValues(typeof(ReoccuranceFrequencyDto)))
                                {
                                    <MudSelectItem Value="@((ReoccuranceFrequencyDto?)item)">@item</MudSelectItem>
                                }
                            </MudSelect>
                        }
                        <MudSelect @bind-Value="TransactionDto.AccountId" Label="Account" Variant="Variant.Outlined"
                            Required="true" RequiredError="Account is required!">
                            @foreach (var account in AllAccounts)
                            {
                                <MudSelectItem Value="@((int?)account.Id)">
                                    <TextWithIcon Text="@account.Name" Icon="@account.Icon" IconColor="@account.Color" IconSize="Size.Small" TextTypo="Typo.body2"></TextWithIcon>
                                </MudSelectItem>
                            }
                        </MudSelect>
                        <MudSelect @bind-Value="TransactionDto.TransactionType" Label="Type" Variant="Variant.Outlined"
                            Required="true" RequiredError="Type of transaction is required!"
                            @bind-Value:after="this.TransactionTypeChanged">
                            @foreach (TransactionTypeDto? item in Enum.GetValues(typeof(TransactionTypeDto)))
                            {
                                <MudSelectItem Value="@((TransactionTypeDto?)item)">@item</MudSelectItem>
                            }
                        </MudSelect>
                        <MudSelect @bind-Value="TransactionDto.CategoryId" Label="Category" Variant="Variant.Outlined"
                            Required="true" RequiredError="Category is required!">
                            @foreach (var category in AllCategories)
                            {
                                <MudSelectItem Value="@((int?)category.Id)">
                                    <TextWithIcon Text="@category.Name" Icon="@category.Icon" IconColor="@category.Color" IconSize="Size.Small" TextTypo="Typo.body2"></TextWithIcon>
                                </MudSelectItem>
                            }
                        </MudSelect>

                        <MudNumericField @bind-Value="TransactionDto.Amount" Label="Amount" Variant="Variant.Outlined"
                            Required="true" RequiredError="Amount is required!" Format="F2">
                        </MudNumericField>
                        <MudPaper Elevation="0" Class="d-flex gap-2">
                            <MudDatePicker @bind-Date="TransactionDto.Date" Label="Date" Variant="Variant.Outlined"
                                Required="true" RequiredError="Date is required!" />

                            <MudTimePicker @bind-Time="TransactionDto.Time" Label="Time" Variant="Variant.Outlined"
                                AmPm="true" Required="true" RequiredError="Time is required!" />
                        </MudPaper>

                        <MudTextField @bind-Value="TransactionDto.Description" Label="Description"
                            Variant="Variant.Outlined">
                        </MudTextField>

                        <MudPaper Elevation="0" Class="d-flex gap-2 mt-4">
                            <MudAutocomplete T="TagDto" @ref="tagAutocomplete" SearchFunc="@TagSearchFunc"
                                ToStringFunc="@(e => e == null ? null : e.Name)" Label="Add Tags" Variant="Variant.Outlined"
                                ValueChanged="@OnTagSelected" Clearable="true" Class="flex-grow-1" MaxItems="null">
                                <ItemTemplate>
                                    <MudPaper Elevation="0" Class="d-flex gap-2" Style="background-color:transparent;">
                                        @if (!string.IsNullOrEmpty(context?.Color))
                                        {
                                            <MudPaper Elevation="0" Class="d-flex gap-2" Style="background-color:transparent;">

                                                <MudChip T="TagDto" Style="@($"background-color:{context.Color}; color:white;")"
                                                    Size="Size.Small">@context.Name</MudChip>

                                                <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small"
                                                    Color="Color.Inherit" Style="color:white;"
                                                    OnClick="@(() => DeleteTag(context))"></MudIconButton>
                                            </MudPaper>
                                        }
                                        else
                                        {
                                            <MudText>@context?.Name</MudText>
                                        }
                                    </MudPaper>
                                </ItemTemplate>
                                <NoItemsTemplate>
                                    <MudText Align="Align.Center" Class="px-4 py-1">
                                        <span>No tags found </span>
                                        @if (!string.IsNullOrWhiteSpace(tagAutocomplete?.Text))
                                        {
                                            <MudPaper Elevation="0" Class="d-flex justify-center mt-2" Style="background-color:transparent;">
                                                <MudButton Variant="Variant.Outlined" OnClick="@CreateNewTag"
                                                    StartIcon="@Icons.Material.Filled.Add">
                                                    Create new tag: @tagAutocomplete.Text
                                                </MudButton>
                                            </MudPaper>
                                        }

                                    </MudText>
                                </NoItemsTemplate>
                            </MudAutocomplete>
                        </MudPaper>
                        <MudPaper Elevation="0" Class="d-flex gap-2 mt-2 flex-wrap">
                            @foreach (var tag in SelectedTags)
                            {
                                <MudPaper Elevation="0" Class="flex gap-2">
                                    <MudChip T="TagDto" Style="@($"background-color:{tag.Color}; color:white;")"
                                        Size="Size.Medium">
                                        <MudText Typo="Typo.body2">@tag.Name</MudText>
                                        <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small"
                                            Color="Color.Inherit" Style="color:white;" OnClick="@(() => RemoveTag(tag))">
                                        </MudIconButton>
                                    </MudChip>
                                </MudPaper>
                            }
                        </MudPaper>
                        

                    </MudForm>
                </MudItem>
                <MudItem xs="12" Class="d-flex justify-end gap-2 mt-6">
                    <MudButton OnClick="Cancel" Variant="Variant.Outlined">Cancel</MudButton>
                    <MudButton OnClick="Submit" Color="Color.Primary" Variant="Variant.Filled">Save</MudButton>
                </MudItem>
            </MudGrid>

        </DialogContent>
    </MudDialog>
}
<style>
    .mud-dialog {
        max-width: 600px !important;
        margin-inline: 15px;
    }
</style>

@code {
    [Parameter]
    public TransactionDto TransactionDto{get; set;} = null!;

    [Parameter]
    public bool IsReoccuring { get; set; } = false;


    [CascadingParameter]
    public required IMudDialogInstance MudDialog { get; set; }

    private MudForm form = new();
    private MudAutocomplete<TagDto>? tagAutocomplete;
    private TagDto? selectedTag;
    private List<TagDto> SelectedTags = new();

    private List<TagDto> AllTags = new();
    private List<CategoryDto> _allCategories = new();
    private List<CategoryDto> AllCategories = new();
    private List<AccountDto> AllAccounts = new();

    private bool Loading = true;
    protected override async Task OnInitializedAsync()
    {
        var lookupsLoaded = await LoadLookupsAsync();
        if (!lookupsLoaded)
        {
            MudDialog.Cancel();
            return;
        }

        InitializeTransactionModel();
        Loading = false;
    }

    private async Task<bool> LoadLookupsAsync()
    {
        var accountsResult = await AccountService.GetAccountsAsync();
        if (!accountsResult.IsSuccess)
        {
            HandleFailure(accountsResult.ErrorMessage, accountsResult.Reason);
            return false;
        }
        AllAccounts = accountsResult.Data ?? new();

        var categoriesResult = await CategoryService.GetCategoriesAsync();
        if (!categoriesResult.IsSuccess)
        {
            HandleFailure(categoriesResult.ErrorMessage, categoriesResult.Reason);
            return false;
        }
        _allCategories = categoriesResult.Data ?? new();

        var tagsResult = await TagService.GetTagsAsync();
        if (!tagsResult.IsSuccess)
        {
            HandleFailure(tagsResult.ErrorMessage, tagsResult.Reason);
            return false;
        }
        AllTags = tagsResult.Data ?? new();

        return true;
    }

    private void InitializeTransactionModel()
    {
        if (TransactionDto == null)
        {
            TransactionDto = new TransactionDto
            {
                TransactionType = TransactionTypeDto.Expense,
                Date = DateTime.Now.Date,
                Time = DateTime.Now.TimeOfDay,
                Amount = 0,
                IsReoccuring = IsReoccuring
            };
            TransactionDto.TagIds = new List<int>();
        }
        else
        {
            TransactionDto.Amount = Math.Abs((decimal)TransactionDto.Amount!);
        }


        AllCategories = _allCategories
            .Where(c => c.Type == TransactionDto.TransactionType)
            .ToList();

        if (TransactionDto.CategoryId == null && AllCategories.Count > 0)
        {
            TransactionDto.CategoryId = AllCategories.First().Id;
            TransactionDto.CategoryDto = AllCategories.First();
            TransactionDto.TransactionType = AllCategories.First().Type;
        }

        if (TransactionDto.AccountId == null && AllAccounts.Count > 0)
        {
            TransactionDto.AccountId = AllAccounts.First().Id;
            TransactionDto.AccountDto = AllAccounts.First();
        }

        if (TransactionDto.TagIds != null && TransactionDto.TagIds.Count > 0)
        {
            SelectedTags = AllTags.Where(t => TransactionDto.TagIds.Contains((int)t.Id!)).ToList();
        }
    }

    private async Task<IEnumerable<TagDto>> TagSearchFunc(string searchText, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            var results = new List<TagDto>(AllTags);
            results.RemoveAll(t => SelectedTags.Any(st => st.Id == t.Id));
            return results;
        }

        var filteredTags = AllTags
        .Where(t => t.Name!.Contains(searchText, StringComparison.OrdinalIgnoreCase))
        .Where(t => !SelectedTags.Any(st => st.Id == t.Id))
        .ToList();

        return await Task.FromResult(filteredTags);
    }

    private async Task OnTagSelected(TagDto tag)
    {
        if (tag != null && !SelectedTags.Any(t => t.Id == tag.Id))
        {
            SelectedTags.Add(tag);
            TransactionDto.TagIds.Add((int)tag.Id!);
            selectedTag = null;
            if (tagAutocomplete != null)
            {
                await tagAutocomplete.ResetAsync();
            }
        }
    }

    private async Task CreateNewTag()
    {
        if (string.IsNullOrWhiteSpace(tagAutocomplete?.Text))
            return;

        var tagDto = new TagDto
        {
            Name = tagAutocomplete.Text,
            Color = "#9E9E9E"
        };

        var result = await TagService.CreateTagAsync(tagDto);
        if (!result.IsSuccess)
        {
            HandleFailure(result.ErrorMessage, result.Reason);
            return;
        }

        AllTags.Add(result.Data!);
        SelectedTags.Add(result.Data!);
        TransactionDto.TagIds.Add((int)result.Data!.Id!);
        selectedTag = null;
        if (tagAutocomplete != null)
        {
            await tagAutocomplete.ResetAsync();
        }
        Snackbar.Add($"Tag '{result.Data.Name}' created!", Severity.Success);
    }

    private void RemoveTag(TagDto tag)
    {
        SelectedTags.Remove(tag);
        TransactionDto.TagIds.Remove((int)tag.Id!);
    }

    private async Task DeleteTag(TagDto tag)
    {
        if (tagAutocomplete != null)
        {
            await tagAutocomplete.CloseMenuAsync();
        }

        var options = new DialogOptions { CloseOnEscapeKey = true };
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.Message, @$"Are you sure you want to delete the ""{tag.Name}"" tag? " }
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>(title: "Warning", parameters, options);
        var result = await dialog.Result;
        if (!result!.Canceled)
        {
            var deleteResult = await TagService.DeleteTagAsync((int)tag.Id!);
            if(!deleteResult.IsSuccess)
            {
                HandleFailure(deleteResult.ErrorMessage, deleteResult.Reason);
                return;
            }

            AllTags.RemoveAll(t => t.Id == tag.Id);
            RemoveTag(tag);
            Snackbar.Add("Tag deleted successfully!", Severity.Success);
            if (tagAutocomplete != null)
            {
                await tagAutocomplete.ResetAsync();
            }
        }
    }

    private async Task Submit()
    {
        await form.Validate();
        if (!form.IsValid)
        {
            StateHasChanged();
            return;
        }
        TransactionDto.TagIds = SelectedTags.Select(t => (int)t.Id!).ToList();

        if(TransactionDto.Date != null){
            TransactionDto.Date = new DateTime(TransactionDto.Date.Value.Year, TransactionDto.Date.Value.Month, TransactionDto.Date.Value.Day,0, 0, 0);
        }

        Result response;

        if (TransactionDto.Id == null)
        {
            response = await TransactionService.CreateTransactionAsync(TransactionDto);
        }
        else
        {
            response = await TransactionService.UpdateTransactionAsync(TransactionDto);
        }

        if(!response.IsSuccess){
            HandleFailure(response.ErrorMessage, response.Reason);
            return;
        }

        Snackbar.Add("Transaction saved successfully!", Severity.Success);
        MudDialog.Close(DialogResult.Ok(result: true));
        return;
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task TransactionTypeChanged()
    {
        AllCategories = _allCategories.Where(c => c.Type == TransactionDto.TransactionType).ToList();

        if (AllCategories.Count > 0)
        {
            TransactionDto.CategoryId = AllCategories.First().Id;
            TransactionDto.CategoryDto = AllCategories.First();
        }
        else{
            TransactionDto.CategoryId = null;
        }

    }

    private void HandleFailure(string? errorMessage, FailureReason reason)
    {
        if (reason == FailureReason.Unauthorized)
        {
            Snackbar.Add("Session expired. Please log in again.", Severity.Error);
            MudDialog.Close();
            NavigationManager.NavigateTo("/login");
        }
        else
        {
            Snackbar.Add(errorMessage ?? "An error occurred.", Severity.Error);
        }
    }

}