@using ApexCharts
@using ExpenseTrackerSharedCL.Features.UserPreferences.Dtos
@using MudBlazor
@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject IApexChartService apexChartService
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudPopoverProvider />
<MudDialogProvider /> 
<MudSnackbarProvider />
<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="_theme" />

<MudLayout>
    @if (IsLoggedIn)
    {
        <MudAppBar Elevation="1">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="MudBlazor.Color.Inherit" Edge="Edge.Start"
                OnClick="@((e) => DrawerToggle())" />
            <MudSpacer />
            <MudSwitch @bind-Value="_isDarkMode" Color="MudBlazor.Color.Primary" Class="ma-4" T="bool" Label="Dark Mode"
                @bind-Value:after="this.ThemeChanged" />
            <MudMenu AnchorOrigin="Origin.BottomLeft" Icon="@Icons.Material.Filled.AccountCircle">
                <ActivatorContent>
                    <MudAvatar Color="MudBlazor.Color.Primary">
                        <MudIcon Icon="@Icons.Material.Filled.Person" />
                    </MudAvatar>
                </ActivatorContent>
                <ChildContent>
                    <div class="px-4 py-4">
                        <MudText Typo="Typo.body2">@email</MudText>
                    </div>
                    <MudDivider />
                    <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="Logout" Color="MudBlazor.Color.Error">Logout</MudMenuItem>
                </ChildContent>
            </MudMenu>
        </MudAppBar>
        <MudDrawer @bind-Open="_drawerOpen" Elevation="2">
            <MudDrawerHeader>
                <MudText Typo="Typo.h5" Class="mt-1">Expense Tracker</MudText>
            </MudDrawerHeader>
            <MudNavMenu>
                <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
                <MudNavLink Href="transactions?isReoccuring=false"  Icon="@Icons.Material.Filled.CompareArrows">
                    Transactions</MudNavLink>
                <MudNavLink Href="accounts" Icon="@Icons.Material.Filled.AccountBalance">Accounts
                </MudNavLink>
                <MudNavLink Href="categories" Icon="@Icons.Material.Filled.Category">Categories
                </MudNavLink>
                <MudNavLink Href="transactions?isReoccuring=true" Icon="@Icons.Material.Filled.Category">
                    Reoccuring transactions
                </MudNavLink>
                <MudNavLink Href="budgets" Icon="@Icons.Material.Filled.Money">Budgets
                </MudNavLink>
            </MudNavMenu>
        </MudDrawer>
    }
    else
    {
        <MudAppBar Elevation="1">
            <MudText Typo="Typo.h5" Class="mt-1">Expense Tracker</MudText>
        </MudAppBar>
    }

    <MudMainContent>
        @Body
    </MudMainContent>

</MudLayout>
@code {

    bool _drawerOpen = true;

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }


    private bool IsLoggedIn = false;
    private string email = "";

    protected override async Task OnInitializedAsync()
    {
        string url = "api/accounts";
        var request = new HttpRequestMessage(HttpMethod.Get, url);
        var response = await Http.SendAsync(request);
        if(response.IsSuccessStatusCode)
        {
            IsLoggedIn = true;
        }
        else
        {
            IsLoggedIn = false;
        }

        if (IsLoggedIn)
        {
            UserPreferenceDto? userPreferenceDto = await GetUserPreferencesDto();
            if(userPreferenceDto == null)
            {
                var result = await SetDefaultUserPreferences();
                if(!result)
                {
                    userPreferenceDto = new();
                    userPreferenceDto.DarkMode = false;
                }
                else
                {
                    userPreferenceDto = await GetUserPreferencesDto();
                }
            }
            _isDarkMode = userPreferenceDto!.DarkMode;
        }
    }


    private async Task<UserPreferenceDto?> GetUserPreferencesDto()
    {
        UserPreferenceDto? userPreferenceDto = null;

        string url = "api/userpreferences";
        var request = new HttpRequestMessage(HttpMethod.Get, url);
        var response = await Http.SendAsync(request);
        if (response.IsSuccessStatusCode)
        {
            userPreferenceDto = await response.Content.ReadFromJsonAsync<UserPreferenceDto>();
        }
        return userPreferenceDto;
    }

    private async Task<bool> SetDefaultUserPreferences()
    {
        string url = "api/userpreferences/default";
        var request = new HttpRequestMessage(HttpMethod.Post, url);
        var response = await Http.SendAsync(request);
        return response.IsSuccessStatusCode;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RefreshGraphs();
        }
    }

    private void Logout()
    {
        var theme = _isDarkMode ? "dark" : "light";
        NavigationManager.NavigateTo($"/api/auth/logout", forceLoad: true);
    }


    private bool _isDarkMode;
    private MudTheme _theme = new();

    private async Task ThemeChanged()
    {
        if (IsLoggedIn)
        {
            await Mediator.Send(new EditUserPreferencesCommand { DarkMode = _isDarkMode, UserId = CurrentUserService.GetUserId() });
        }

        await RefreshGraphs();
        StateHasChanged();
    }

    private async Task RefreshGraphs()
    {
        await ApexChartService.SetGlobalOptionsAsync(new ApexChartBaseOptions
        {
            Debug = false,
            Theme = new Theme
            {
                Mode = _isDarkMode ? Mode.Dark : Mode.Light,
                Palette = PaletteType.Palette6
            },
            Chart = new Chart
            {
                Background = "transparent"
            }
        }, true);
    }

    private void RedirectToTransctions(bool reoccuring)
    {
        NavigationManager.NavigateTo($"/transactions?isreoccuring={reoccuring}", forceLoad: true);
    }

}