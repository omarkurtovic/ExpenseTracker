@rendermode InteractiveWebAssembly

@using ExpenseTrackerSharedCL.Features.Accounts.Dtos
@using ExpenseTrackerSharedCL.Features.Accounts.Services
@using ExpenseTrackerSharedCL.Features.Categories
@using ExpenseTrackerSharedCL.Features.Categories.Dtos
@using ExpenseTrackerSharedCL.Features.Tags.Dtos
@using ExpenseTrackerSharedCL.Features.Tags.Service
@using ExpenseTrackerWasmWebApp.Features.Accounts.Services
@using ExpenseTrackerWasmWebApp.Features.Categories.Services
@using ExpenseTrackerWasmWebApp.Features.Tags.Services
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using ExpenseTrackerSharedCL.Features.Transactions.Dtos
@using ExpenseTrackerSharedCL.Features.Transactions.Enums
@using ExpenseTrackerWasmWebApp.Features.SharedKernel.Components

@inject IAccountService AccountService
@inject ICategoryService CategoryService
@inject ITagService TagService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<MudGrid>
    <MudItem xs="12" md="6">
        <MudPaper Elevation="0" Class="d-flex gap-5">
            <MudSelect T="AccountDto" Label="Account" @bind-SelectedValues="Filters.AccountsFilter"
                MultiSelectionTextFunc="@(new Func<List<string>, string>(GetAccountsMultiSelectionText))"
                MultiSelection="true" Clearable="true" FullWidth="true">
                @foreach (var account in Accounts)
                {
                    <MudSelectItem T="AccountDto" Value="@(account)">
                        <TextWithIcon Text="@account.Name" Icon="@account.Icon" IconColor="@account.Color" IconSize="Size.Small" TextTypo="Typo.body2"></TextWithIcon>
                    </MudSelectItem>
                }
            </MudSelect>
            <MudSelect T="DateFilterPreset ?" Label="Date" @bind-Value="Filters.DateFilter"
                FullWidth="true" Clearable="true">
                <MudSelectItem Value="@((DateFilterPreset?)DateFilterPreset.ThisMonth)">This Month
                </MudSelectItem>
                <MudSelectItem Value="@((DateFilterPreset?)DateFilterPreset.LastMonth)">Last Month
                </MudSelectItem>
                <MudSelectItem Value="@((DateFilterPreset?)DateFilterPreset.Last3Months)">Last Three Months
                </MudSelectItem>
                <MudSelectItem Value="@((DateFilterPreset?)DateFilterPreset.ThisYear)">This Year
                </MudSelectItem>
            </MudSelect>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="6">
        <MudPaper Elevation="0" Class="d-flex gap-5">
            <MudSelect T="TransactionTypeDto?" Label="Type" @bind-Value="Filters.TypeFilter"
                Clearable="true" FullWidth="true">
                @foreach (TransactionTypeDto item in Enum.GetValues(typeof(TransactionTypeDto)))
                {
                    <MudSelectItem Value="@((TransactionTypeDto?)item)">@item</MudSelectItem>
                }
            </MudSelect>
            <MudSelect T="CategoryDto" Label="Category" @bind-SelectedValues="Filters.CategoriesFilter"
                MultiSelectionTextFunc="@(new Func<List<string>, string>(GetCategoriesMultiSelectionText))"
                MultiSelection="true" Clearable="true" FullWidth="true">
                @foreach (var category in Categories)
                {
                    <MudSelectItem T="CategoryDto" Value="@(category)">
                        <TextWithIcon Text="@category.Name" Icon="@category.Icon" IconColor="@category.Color" IconSize="Size.Small" TextTypo="Typo.body2"></TextWithIcon>
                    </MudSelectItem>
                }
            </MudSelect>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="6">
        <MudSelect T="TagDto" Label="Tags" @bind-SelectedValues="Filters.TagsFilter"
            MultiSelectionTextFunc="@(new Func<List<string>, string>(GetTagsMultiSelectionText))"
            MultiSelection="true" Clearable="true" FullWidth="true">
            @foreach (var tag in Tags)
            {
                <MudSelectItem Value="@(tag)">
                    <MudChip T="TagDto" Style="@($"background-color:{tag.Color}; color:white;")" Size="Size.Small"
                        Variant="Variant.Filled">
                        @tag.Name
                    </MudChip>
                </MudSelectItem>
            }
        </MudSelect>
    </MudItem>
    <MudItem xs="12" md="2" Class="d-flex justify-center align-end">
        <MudButton Variant="Variant.Outlined" OnClick="ClearFilters"
            Disabled="@(!AreAnyFiltersActive())"
            StartIcon="@Icons.Material.Filled.FilterListOff">Clear
        </MudButton>
    </MudItem>
    <MudItem xs="12" md="2" Class="d-flex justify-center align-end">
        <MudButton Variant="Variant.Outlined" OnClick="ApplyFilters"
            StartIcon="@Icons.Material.Filled.FilterList">Apply
        </MudButton>
    </MudItem>
</MudGrid>


@code{
    [Parameter]
    public Func<Task> RefreshDataGridAction { get; set; } = null!;

    [Parameter]
    public TransactionsFiltersDto Filters { get; set; } = new TransactionsFiltersDto();

    private List<AccountDto> Accounts = [];
    private List<CategoryDto> Categories = [];
    private List<TagDto> Tags = [];
    protected override async Task OnInitializedAsync()
    {
        var lookupsLoaded = await LoadLookupsAsync();
        if (!lookupsLoaded)
        {
            return;
        }
    }

    private async Task<bool> LoadLookupsAsync()
    {
        var accountsResult = await AccountService.GetAccountsAsync();
        if (!accountsResult.IsSuccess)
        {
            HandleFailure(accountsResult.ErrorMessage, accountsResult.Reason);
            return false;
        }
        Accounts = accountsResult.Data ?? new();

        var categoriesResult = await CategoryService.GetCategoriesAsync();
        if (!categoriesResult.IsSuccess)
        {
            HandleFailure(categoriesResult.ErrorMessage, categoriesResult.Reason);
            return false;
        }
        Categories = categoriesResult.Data ?? new();

        var tagsResult = await TagService.GetTagsAsync();
        if (!tagsResult.IsSuccess)
        {
            HandleFailure(tagsResult.ErrorMessage, tagsResult.Reason);
            return false;
        }
        Tags = tagsResult.Data ?? new();

        return true;
    }

    private async void ClearFilters()
    {
        Filters = new TransactionsFiltersDto();
        await RefreshDataGridAction();
    }

    private async void ApplyFilters()
    {
        await RefreshDataGridAction();
    }




    public bool AreAnyFiltersActive()
    {
        return Filters.AreAnyFiltersActive();
    }
    private string GetAccountsMultiSelectionText(List<string> selectedAccounts)
    {
        return string.Join(", ", selectedAccounts);
    }

    private string GetCategoriesMultiSelectionText(List<string> selectedCategories)
    {
        return string.Join(separator: ", ", selectedCategories);
    }

    private string GetTagsMultiSelectionText(List<string> selectedTags)
    {
        return string.Join(separator: ", ", selectedTags);
    }

     private void HandleFailure(string? errorMessage, FailureReason reason)
    {
        if (reason == FailureReason.Unauthorized)
        {
            Snackbar.Add("Session expired. Please log in again.", Severity.Error);
            NavigationManager.NavigateTo("/login");
        }
        else
        {
            Snackbar.Add(errorMessage ?? "An error occurred.", Severity.Error);
        }
    }
}