
@page "/login"
@attribute [AllowAnonymous]
@using ExpenseTrackerSharedCL.Features.Auth.Dtos
@using ExpenseTrackerWasmWebApp.Features.Auth.Services
@using ExpenseTrackerWasmWebApp.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@layout ExpenseTrackerWasmWebApp.Features.SharedKernel.Layouts.UnauthorizeLayout
@inject ISnackbar Snackbar
@inject NavigationManager Nav    
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthService AuthService

<MudThemeProvider />

<PageTitle>Login</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" >
    <MudPaper Class="pa-6 mt-6" Elevation="15">
        <MudForm @ref="form">
            <MudGrid>
                <MudItem xs="12" Class="d-flex justify-center">
                    <MudText Typo="Typo.h4">Welcome back!</MudText>
                </MudItem>
                <MudItem xs="12">
                        <MudTextField @bind-Value="loginRequest.Email" Label="Email" Variant="Variant.Text"
                            Required="true" RequiredError="Email is required!">
                        </MudTextField>
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="loginRequest.Password" Label="Password"
                    Required="true" RequiredError="Password is required!"
                        Variant="Variant.Text" InputType="@PasswordInput"
                        Adornment="Adornment.End" AdornmentIcon="@PasswordInputIcon"
                        OnAdornmentClick="ShowPasswordClick" AdornmentAriaLabel="Show Password" />

                </MudItem>
                <MudItem xs="12" Class="d-flex justify-center">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@BtnLogin_Click" Class="px-20 py-1">Login</MudButton>
                </MudItem>
                <MudItem xs="12" Class="d-flex justify-center mt-10">
                    <MudText Typo="Typo.body1">Dont't have an account? Register <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="BtnRegister_Click">HERE</MudButton></MudText>
                </MudItem>
            </MudGrid>
        </MudForm>
    </MudPaper>
</MudContainer>
    
@code{
    LoginRequestDto loginRequest = new LoginRequestDto();

    private MudForm form = null!;
    private bool isShow;
    private InputType PasswordInput = InputType.Password;
    private string PasswordInputIcon = Icons.Material.Filled.VisibilityOff;

    private async Task BtnLogin_Click(){
        
        await form.Validate();
        if (!form.IsValid)
        {
            return;
        }

        await HandleLogin();
    }
    
    private async Task HandleLogin()
    {
        var result = await AuthService.LoginAsync(loginRequest);
        if(!result.IsSuccess){
            Snackbar.Add(result.ErrorMessage ?? "Login failed. Please check your credentials and try again.", Severity.Error);
            return;
        }

        await LocalStorage.SetItemAsync("authToken", result.Data!.Token);
        if (AuthStateProvider is CustomAuthenticationStateProvider customAuth)
        {
            await customAuth.MarkUserAsAuthenticatedAsync(result.Data!.Token);
        }
        Nav.NavigateTo(uri: "/");
    }

    private void BtnRegister_Click(){
        Nav.NavigateTo("Register");
    }
    
    private void ShowPasswordClick()
    {
        @if (isShow)
        {
            isShow = false;
            PasswordInputIcon = Icons.Material.Filled.VisibilityOff;
            PasswordInput = InputType.Password;
        }
        else {
            isShow = true;
            PasswordInputIcon = Icons.Material.Filled.Visibility;
            PasswordInput = InputType.Text;
        }
    }
}