@page "/"
@using ExpenseTracker.Components.Pages.Dialogs
@using ExpenseTracker.Database.Models
@using ExpenseTracker.Dtos
@using ExpenseTracker.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor.Extensions
@using System.Globalization

@inject TransactionService TransactionService
@inject CategoryService CategoryService
@inject AccountService AccountService
@inject IDialogService DialogService
@inject SeedDataService SeedDataService

<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<PageTitle>Dashboard</PageTitle>

<MudContainer>
    <MudPaper Class="pa-6 mt-6" Elevation="0">
        <MudGrid>
            <MudItem xs="12" Class="d-flex justify-center">
                <MudText Typo="Typo.h3">
                    Welcome back @username
                </MudText>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudPaper Elevation="5" Class="pa-4">
                    <MudText Typo="Typo.h6">
                        Balance
                    </MudText>
                    <MudText Typo="Typo.h4" Class="mt-4">
                        @balance.ToString("C2")
                    </MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudPaper Elevation="5" Class="pa-4">
                    <MudText Typo="Typo.h6">
                        Income this month
                    </MudText>
                    <MudText Typo="Typo.h4" Class="mt-4">
                        @incomeThisMonth.ToString("C2")
                    </MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudPaper Elevation="5" Class="pa-4">
                    <MudText Typo="Typo.h6">
                        Expenses this month
                    </MudText>
                    <MudText Typo="Typo.h4" Class="mt-4">
                        @expensesThisMonth.ToString("C2")
                    </MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="6" Class="d-flex">
                @if (ExpenseIncomeGraphSeries is not null && ExpenseIncomeGraphXAxisLabels is not null)
                {
                    <MudPaper Elevation="5" Class="pa-4 flex-grow-1">
                        <MudText Typo="Typo.h6">
                            Expenses and Income last 6 months
                        </MudText>
                        <MudChart ChartType="ChartType.Bar" ChartSeries="@ExpenseIncomeGraphSeries"
                            XAxisLabels="@ExpenseIncomeGraphXAxisLabels" Width="100%" Class="mt-4">
                        </MudChart>
                    </MudPaper>
                }
            </MudItem>
            <MudItem xs="12" md="6"  Class="d-flex">
                @if (topCategoriesGraphData is not null && topCategoriesGraphLabels is not null)
                {
                    <MudPaper Elevation="5" Class="pa-4 flex-grow-1">
                        <MudText Typo="Typo.h6">
                            Top Expenses last 6 months
                        </MudText>
                        <MudChart ChartType="ChartType.Donut"
                            InputData="@topCategoriesGraphData" InputLabels="@topCategoriesGraphLabels" Class="mt-4">
                        </MudChart>
                    </MudPaper>
                }
            </MudItem>
            <MudItem xs="12">
                @if (latestTransactions is not null)
                {
                    <MudPaper Elevation="5" Class="pa-4">
                        <MudText Typo="Typo.h6">
                            Latest transactions
                        </MudText>
                        <MudDataGrid T="Transaction" Items="@latestTransactions" Class="mt-4">
                            <Columns>
                                <TemplateColumn Title="Amount">
                                    <CellTemplate>
                                        @(context.Item.Category.Type == TransactionType.Expense ? -context.Item.Amount :
                                                                            context.Item.Amount)
                                    </CellTemplate>
                                </TemplateColumn>
                                <PropertyColumn Property="t => t.Date" Title="Date"></PropertyColumn>
                                <PropertyColumn Property="t => t.Category.Name" Title="Category"></PropertyColumn>
                                <PropertyColumn Property="t => t.Description" Title="Description"></PropertyColumn>
                            </Columns>
                        </MudDataGrid>
                    </MudPaper>
                }
            </MudItem>
        </MudGrid>
    </MudPaper>
</MudContainer>

@code {

    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }
    private string username = "";
    private decimal balance = 0;
    private decimal incomeThisMonth = 0;
    private decimal expensesThisMonth = 0;

    private List<Transaction> latestTransactions = new List<Transaction>();
    protected override async Task OnInitializedAsync()
    {
        if (authenticationState is not null)
        {
            var authState = await authenticationState;
            var user = authState?.User;

            if (user?.Identity is not null && user.Identity.IsAuthenticated)
            {
                username = user.Identity.Name ?? "";
            }
        }

        List<Transaction> transactions = await TransactionService.GetAllAsync();
        latestTransactions = transactions.OrderByDescending(t => t.Date).Take(5).ToList();

        List<AccountWithBalance> accounts = await AccountService.GetAllWithBalanceAsync();


        SetupHeader(transactions, accounts);
        SetupExpenseIncomeGraph(transactions);
        SetupTopCategoriesGraph(transactions);
    }

    private void SetupHeader(List<Transaction> transactions, List<AccountWithBalance> accounts)
    {
        balance = accounts.Sum(a => a.CurrentBalance);
        var transactionsThisMonth = transactions
        .Where(t => t.Date >= DateTime.Now.StartOfMonth(CultureInfo.CurrentCulture))
        .ToList();

        foreach (var transaction in transactionsThisMonth)
        {
            if (transaction.Category.Type == TransactionType.Expense)
            {
                expensesThisMonth += transaction.Amount;
            }
            else if (transaction.Category.Type == TransactionType.Income)
            {
                incomeThisMonth += transaction.Amount;
            }
        }
        expensesThisMonth = -expensesThisMonth;
    }


    private List<ChartSeries> ExpenseIncomeGraphSeries = new List<ChartSeries>()
    {
        new ChartSeries() { Name = "Income", Data = new double[6]},
        new ChartSeries() { Name = "Expenses", Data = new double[6]}
    };
    private string[] ExpenseIncomeGraphXAxisLabels = new string[6];

    private void SetupExpenseIncomeGraph(List<Transaction> transactions)
    {
        // including the current month 5 + 1 = 6 months in total
        int monthsToScan = 5;
        for (int i = 0; i <= monthsToScan; ++i)
        {
            var iMonthsAgo = DateTime.Now.AddMonths(i - monthsToScan);
            var startOfMonth = iMonthsAgo.StartOfMonth(CultureInfo.CurrentCulture);
            var endOfMonth = iMonthsAgo.EndOfMonth(CultureInfo.CurrentCulture);

            var monthName = startOfMonth.ToString("MMM");
            ExpenseIncomeGraphXAxisLabels[i] = monthName;

            var transactionsThisMonth = transactions.Where(t => t.Date >= startOfMonth && t.Date <= endOfMonth).ToList();
            double income = 0;
            double expense = 0;
            foreach (var t in transactionsThisMonth)
            {
                if (t.Category.Type == TransactionType.Income)
                {
                    income += (double)t.Amount;
                }
                else if (t.Category.Type == TransactionType.Expense)
                {
                    expense += (double)t.Amount;
                }
            }

            ExpenseIncomeGraphSeries[0].Data[i] = income;
            ExpenseIncomeGraphSeries[1].Data[i] = -expense;
        }
    }

    private double[] topCategoriesGraphData = new double[6];
    private string[] topCategoriesGraphLabels = ["", "", "", "", "", ""];

    private void SetupTopCategoriesGraph(List<Transaction> transactions, int numOfMonthsBehind = 6)
    {

        var dateStart = DateTime.Now.AddMonths(-numOfMonthsBehind).StartOfMonth(CultureInfo.CurrentCulture);
        var topCategories = transactions
        .Where(t => t.Category.Type == TransactionType.Expense)
        .Where(t => t.Date >= dateStart)
        .GroupBy(t => t.Category)
        .Select(g => new
        {
            Category = g.Key,
            TotalExpense = g.Sum(t => -t.Amount)
        })
        .OrderByDescending(g => g.TotalExpense).ToList();

        double total = (double)topCategories.Sum(c => c.TotalExpense);

        for (int i = 0; i < 5 && i < topCategories.Count; ++i)
        {
            topCategoriesGraphLabels[i] = topCategories[i].Category.Name;
            topCategoriesGraphData[i] = Math.Floor(((double)topCategories[i].TotalExpense * 100) / total);
        }
        if (topCategories.Count > 5)
        {
            topCategoriesGraphLabels[5] = "Other";
            topCategoriesGraphData[5] = 100 - topCategoriesGraphData.Sum(t => t);
        }
    }

}