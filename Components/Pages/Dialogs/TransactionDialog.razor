@using ExpenseTracker.Database.Models
@using ExpenseTracker.Services
@inject TransactionService TransactionService
@inject CategoryService CategoryService

<MudDialog>
    <TitleContent>
        Transaction
    </TitleContent>
    <DialogContent>
            <MudForm @ref="form">
                <div style="display: flex; flex-direction: column; gap: 1rem; min-width: 350px;">
                    <MudSelect T="TransactionType" Label="Type" Required="true" @bind-Value="_type"
                        RequiredError="Type of transaction is required!" @bind-Value:after="this.TransactionTypeChanged">
                        @foreach (TransactionType item in Enum.GetValues(typeof(TransactionType)))
                        {
                            <MudSelectItem Value="@item">@item</MudSelectItem>
                        }
                    </MudSelect>
                    
                    @if(Transaction is not null){
                        <MudNumericField @bind-Value="Transaction.Amount" Label="Amount" Variant="Variant.Text" Required="true"
                            RequiredError="Amount is required!">
                        </MudNumericField>
                    }

                    @if(Category is not null){
                        <MudSelect @bind-Value="Category.Id" Label="Category" Required="true"
                            RequiredError="Category is required!">
                            @foreach (var category in Categories)
                            {
                                <MudSelectItem Value="@category.Id">@category.Name</MudSelectItem>
                            }
                        </MudSelect>
                    }

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        @if(_date is not null){
                            <MudDatePicker Label="Date" @bind-Date="_date" Required="true" RequiredError="Date is required!" />
                        }
                        @if(_time is not null){
                            <MudTimePicker Label="Time" AmPm="true" @bind-Time="_time" RequiredError="Time is required!" />
                        }
                    </div>

                    @if(Transaction is not null){
                        <MudTextField @bind-Value="Transaction.Description" Label="Description" Variant="Variant.Text">
                        </MudTextField>
                    }
                </div>
            </MudForm>
    </DialogContent>
    <DialogActions>
        <div style="display: flex; flex-direction: row; gap: 1rem;">
            <MudButton Color="Color.Primary" OnClick="Submit">Save</MudButton>
            <MudButton OnClick="Cancel">Cancel</MudButton>
        </div>
    </DialogActions>
</MudDialog>

@code {
    MudForm form;

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public int? TransactionId { get; set; }


    private DateTime? _date = DateTime.Now;
    private TimeSpan? _time = DateTime.Now.Date.TimeOfDay;

    private TransactionType _type = TransactionType.Expense;
    private Transaction Transaction = new();
    private Category Category = new();
    private List<Category> Categories = new List<Category>();

    protected override async Task OnInitializedAsync()
    {
        Transaction = new Transaction();
        Transaction.Date = DateTime.Now;
        Transaction.Amount = 0;

        Categories = await CategoryService.GetAllAsync();
        // no point making transaction if we don't have any categories

        if (Categories.Count == 0)
        {
            MudDialog.Close();
            return;
        }

        Category = new Category();
        Category = Categories.First();

        
        _type = Category.Type;
        _date = Transaction.Date.Date;
        _time = Transaction.Date.TimeOfDay;
    }

    protected override async Task OnParametersSetAsync(){
        
        if (TransactionId == null)
        {
            return;
        }

        Transaction = await TransactionService.GetAsync((int)TransactionId);

        // if we failed to get the transaction break immediately
        if (Transaction == null)
        {
            MudDialog.Close();
            return;
        }
        Category = Transaction.Category;

        _type = Category.Type;
        _date = Transaction.Date.Date;
        _time = Transaction.Date.TimeOfDay;
        Categories = Categories.Where(c => c.Type == Category.Type).ToList();
        StateHasChanged();
    }

    private async void Submit()
    {
        await form.Validate();
        if (!form.IsValid)
        {
            return;
        }

        // since we validate first
        // we know that _date and _time have values
        Transaction.Date = (DateTime)(_date + _time);
        Transaction.CategoryId = Category.Id;
        
        await TransactionService.Save(Transaction);
        MudDialog.Close(DialogResult.Ok(result: true));
    }

    private void Cancel() => MudDialog.Cancel();

    private async void TransactionTypeChanged()
    {
        Categories = await CategoryService.GetAllAsync();
        Categories = Categories.Where(c => c.Type == _type).ToList();
        Category = Categories.First();
        StateHasChanged();
    }
}