@using ApexCharts
@using ExpenseTrackerWebApp.Services
@using Microsoft.AspNetCore.Components.Authorization
@inherits LayoutComponentBase
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IdentityService IdentityService
@inject NavigationManager NavigationManager
@inject UserPreferencesService UserPreferencesService
@inject IApexChartService ApexChartService

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="_theme"/>

<MudLayout>
    @if(IsLoggedIn){
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="MudBlazor.Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudSpacer />
        <MudSwitch @bind-Value="_isDarkMode" Color="MudBlazor.Color.Primary"
            Class="ma-4" T="bool" Label="Dark Mode" @bind-Value:after="this.ThemeChanged"/>
        <MudButton Variant="Variant.Text" Color="MudBlazor.Color.Error" OnClick="Logout">Logout</MudButton>
    </MudAppBar>
        <MudDrawer @bind-Open="_drawerOpen" Elevation="2">
            <MudDrawerHeader>
                <MudText Typo="Typo.h5" Class="mt-1">Expense Tracker</MudText>
            </MudDrawerHeader>
            <MudNavMenu>
                <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
                <MudNavLink Href="accounts" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.AccountBalance">Accounts</MudNavLink>
                <MudNavLink Href="transactions" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.CompareArrows">Transactions</MudNavLink>
                <MudNavLink Href="categories" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Category">Categories</MudNavLink>
            </MudNavMenu>
        </MudDrawer>
    }
    else{
        <MudAppBar Elevation="1">
            <MudText Typo="Typo.h5" Class="mt-1">Expense Tracker</MudText>
        </MudAppBar>
    }
    
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>
@code{

    bool _drawerOpen = true;

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }


    private bool IsLoggedIn = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if(user.Identity?.IsAuthenticated ?? false){
            IsLoggedIn = true;
        }

        if(IsLoggedIn){
            var userPreferences = await UserPreferencesService.GetAsync();
            if(userPreferences == null){
                await UserPreferencesService.SaveAsync(_isDarkMode);
                userPreferences = await UserPreferencesService.GetAsync();
            }

            _isDarkMode = userPreferences.DarkMode;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender){
            await RefreshGraphs();
        }
    }

    private void Logout(){
        var theme = _isDarkMode ? "dark" : "light";
        NavigationManager.NavigateTo($"/api/auth/logout", forceLoad: true);
    }


    private bool _isDarkMode;
    private MudTheme _theme = new();
    
    private async Task ThemeChanged(){    
        if(IsLoggedIn){
            await UserPreferencesService.SaveAsync(_isDarkMode);
        }

        await RefreshGraphs();
        StateHasChanged();
    }

    private async Task RefreshGraphs(){
        await ApexChartService.SetGlobalOptionsAsync(new ApexChartBaseOptions
        {
            Debug = false,
            Theme = new Theme 
            { 
                Mode = _isDarkMode ? Mode.Dark : Mode.Light,
                Palette = PaletteType.Palette6 
            },
            Chart = new Chart
            {
                Background = "transparent"
            }
        }, true);
    }
}