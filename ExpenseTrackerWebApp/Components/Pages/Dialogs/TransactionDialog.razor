@using ExpenseTrackerWebApp.Database.Models
@using ExpenseTrackerWebApp.Dtos
@using ExpenseTrackerWebApp.Services
@using Microsoft.AspNetCore.Authorization
@using ExpenseTrackerWebApp.Components.MyComponents;
@using MudBlazor
@inject TransactionService TransactionService
@inject CategoryService CategoryService
@inject AccountService AccountService
@inject TagService TagService
@inject ISnackbar Snackbar

<title>Accounts</title>

@if (TransactionDto is not null)
{
    <MudDialog>
        <TitleContent>
            <MudText Typo="Typo.h5">
                @(TransactionId == null ? "Add Transaction" : "Edit Transaction")
            </MudText>
        </TitleContent>
        <DialogContent>
            <MudGrid>
                <MudItem xs="12">
                    <MudForm @ref="form">
                        @if (Reoccuring)
                        {
                            <MudAlert Severity="Severity.Info" Elevation="0" Variant="Variant.Filled" Class="mb-4">
                                You are adding a reoccuring transaction. This transaction will be repeated based on the
                                reoccuring settings.
                            </MudAlert>


                            <MudSelect @bind-Value="TransactionDto.ReoccuranceFrequency" Label="Reoccurance type"
                                Variant="Variant.Outlined" Required="true" RequiredError="Reoccurance type is required!"
                                @bind-Value:after="this.TransactionTypeChanged">
                                @foreach (ReoccuranceFrequency? item in Enum.GetValues(typeof(ReoccuranceFrequency)))
                                {
                                    <MudSelectItem Value="@((ReoccuranceFrequency?)item)">@item</MudSelectItem>
                                }
                            </MudSelect>
                        }
                        <MudSelect @bind-Value="TransactionDto.AccountId" Label="Account" Variant="Variant.Outlined"
                            Required="true" RequiredError="Account is required!">
                            @foreach (var account in Accounts)
                            {
                                <MudSelectItem Value="@((int?)account.Id)">@account.Name</MudSelectItem>
                            }
                        </MudSelect>
                        <MudSelect @bind-Value="TransactionDto.TransactionType" Label="Type" Variant="Variant.Outlined"
                            Required="true" RequiredError="Type of transaction is required!"
                            @bind-Value:after="this.TransactionTypeChanged">
                            @foreach (TransactionType? item in Enum.GetValues(typeof(TransactionType)))
                            {
                                <MudSelectItem Value="@((TransactionType?)item)">@item</MudSelectItem>
                            }
                        </MudSelect>
                        <MudSelect @bind-Value="TransactionDto.CategoryId" Label="Category" Variant="Variant.Outlined"
                            Required="true" RequiredError="Category is required!">
                            @foreach (var category in Categories)
                            {
                                <MudSelectItem Value="@((int?)category.Id)">
                                    <MudPaper Elevation="0" Class="d-flex gap-3 align-end" Style="background: transparent;">
                                        <MudIcon Icon="@category.Icon" Style="@($"color: {category.Color};")"
                                            Size="Size.Small" />
                                        <MudText Typo="Typo.body2">@category.Name</MudText>
                                    </MudPaper>
                                </MudSelectItem>
                            }
                        </MudSelect>

                        <MudNumericField @bind-Value="TransactionDto.Amount" Label="Amount" Variant="Variant.Outlined"
                            Required="true" RequiredError="Amount is required!" Format="C2">
                        </MudNumericField>
                        <MudPaper Elevation="0" Class="d-flex gap-2">
                            <MudDatePicker @bind-Date="TransactionDto.Date" Label="Date" Variant="Variant.Outlined"
                                Required="true" RequiredError="Date is required!" />

                            <MudTimePicker @bind-Time="TransactionDto.Time" Label="Time" Variant="Variant.Outlined"
                                AmPm="true" Required="true" RequiredError="Time is required!" />
                        </MudPaper>

                        <MudTextField @bind-Value="TransactionDto.Description" Label="Description"
                            Variant="Variant.Outlined">
                        </MudTextField>

                        <MudPaper Elevation="0" Class="d-flex gap-2 mt-4">
                            <MudAutocomplete T="Tag" @ref="tagAutocomplete" SearchFunc="@TagSearchFunc"
                                ToStringFunc="@(e => e == null ? null : e.Name)" Label="Add Tags" Variant="Variant.Outlined"
                                ValueChanged="@OnTagSelected" Clearable="true" Class="flex-grow-1">
                                <ItemTemplate>
                                    <MudPaper Elevation="0" Class="d-flex gap-2">
                                        @if (!string.IsNullOrEmpty(context?.Color))
                                        {
                                            <MudPaper Elevation="0" Class="d-flex gap-2">

                                                <MudChip T="Tag" Style="@($"background-color:{context.Color}; color:white;")"
                                                    Size="Size.Small">@context.Name</MudChip>

                                                <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small"
                                                    Color="Color.Inherit" Style="color:white;"
                                                    OnClick="@(() => DeleteTag(context))"></MudIconButton>
                                            </MudPaper>
                                        }
                                        else
                                        {
                                            <MudText>@context?.Name</MudText>
                                        }
                                    </MudPaper>
                                </ItemTemplate>
                                <NoItemsTemplate>
                                    <MudText Align="Align.Center" Class="px-4 py-1">
                                        <span>No tags found </span>
                                        @if (!string.IsNullOrWhiteSpace(tagAutocomplete?.Text))
                                        {
                                            <MudPaper Elevation="0" Class="d-flex justify-center mt-2">
                                                <MudButton Variant="Variant.Outlined" OnClick="@CreateNewTag"
                                                    StartIcon="@Icons.Material.Filled.Add">
                                                    Create new tag: <strong>@tagAutocomplete.Text</strong>
                                                </MudButton>
                                            </MudPaper>
                                        }

                                    </MudText>
                                </NoItemsTemplate>
                            </MudAutocomplete>
                        </MudPaper>

                        <MudPaper Elevation="0" Class="d-flex gap-2 mt-2 flex-wrap">
                            @foreach (var tag in SelectedTags)
                            {
                                <MudPaper Elevation="0" Class="flex gap-2">
                                    <MudChip T="Tag" Style="@($"background-color:{tag.Color}; color:white;")"
                                        Size="Size.Medium">
                                        <MudText Typo="Typo.body2">@tag.Name</MudText>
                                        <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small"
                                            Color="Color.Inherit" Style="color:white;" OnClick="@(() => RemoveTag(tag))">
                                        </MudIconButton>
                                    </MudChip>
                                </MudPaper>
                            }
                        </MudPaper>

                    </MudForm>
                </MudItem>
                <MudItem xs="12" Class="d-flex justify-end gap-2 mt-6">
                    <MudButton OnClick="Cancel" Variant="Variant.Outlined">Cancel</MudButton>
                    <MudButton OnClick="Submit" Color="Color.Primary" Variant="Variant.Filled">Save</MudButton>
                </MudItem>
            </MudGrid>

        </DialogContent>
    </MudDialog>
}
<style>
    .mud-dialog {
        max-width: 600px !important;
        margin-inline: 15px;
    }
</style>

@code {

    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public int? TransactionId { get; set; }

    [Parameter]
    public bool Reoccuring { get; set; }
    MudForm? form;
    MudAutocomplete<Tag>? tagAutocomplete;
    Tag? selectedTag;
    private List<Tag> AllTags = new();
    private List<Tag> SelectedTags = new();
    private List<Category>? Categories { get; set; }
    private List<Account>? Accounts { get; set; }
    private TransactionDto? TransactionDto { get; set; }

    protected override async Task OnParametersSetAsync()
    {

        await base.OnParametersSetAsync();
        Categories = await CategoryService.GetAllAsync();
        if (Categories.Count == 0)
        {
            Snackbar.Add("No categories found! Create some then try again!", Severity.Error);
            MudDialog.Close();
            return;
        }

        Accounts = await AccountService.GetAllAsync();
        if (Accounts.Count == 0)
        {
            Snackbar.Add("No accounts found! Create some then try again!", Severity.Error);
            MudDialog.Close();
            return;
        }

        AllTags = await TagService.GetAllAsync();

        TransactionDto = new TransactionDto();
        TransactionDto.AccountId = Accounts.First().Id;
        TransactionDto.CategoryId = Categories.First().Id;
        TransactionDto.TransactionType = Categories.First().Type;
        TransactionDto.Date = DateTime.Now;
        TransactionDto.Time = DateTime.Now.TimeOfDay;
        TransactionDto.Amount = 0;
        SelectedTags = new();
        TransactionDto.Reoccuring = Reoccuring;
        if (TransactionId != null)
        {
            var transaction = await TransactionService.GetAsync((int)TransactionId);
            if (transaction == null)
            {
                Snackbar.Add("Server error! Please try again.", Severity.Error);
                MudDialog.Close();
                return;
            }

            TransactionDto = new TransactionDto()
            {
                Id = transaction.Id,
                Amount = Math.Abs(transaction.Amount),
                AccountId = transaction.AccountId,
                CategoryId = transaction.CategoryId,
                Date = transaction.Date.Date,
                Time = transaction.Date.TimeOfDay,
                Description = transaction.Description,
                TransactionType = transaction.Category.Type,
                TagIds = transaction.TransactionTags.Select(tt => tt.TagId).ToList(),
                Reoccuring = transaction.IsReoccuring,
                ReoccuranceFrequency = transaction.ReoccuranceFrequency,
            };
            SelectedTags = transaction.TransactionTags.Select(tt => tt.Tag).ToList();
        }
        Categories = Categories.Where(c => c.Type == TransactionDto.TransactionType).ToList();
    }

    private async Task<IEnumerable<Tag>> TagSearchFunc(string searchText, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            var results = new List<Tag>(AllTags);
            results.RemoveAll(t => SelectedTags.Any(st => st.Id == t.Id));
            return results;
        }

        var filteredTags = AllTags
        .Where(t => t.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase))
        .Where(t => !SelectedTags.Any(st => st.Id == t.Id))
        .ToList();

        return await Task.FromResult(filteredTags);
    }

    private async Task OnTagSelected(Tag tag)
    {
        if (tag != null && !SelectedTags.Any(t => t.Id == tag.Id))
        {
            SelectedTags.Add(tag);
            TransactionDto.TagIds.Add(tag.Id);
            selectedTag = null;
            if (tagAutocomplete != null)
            {
                await tagAutocomplete.ResetAsync();
            }
        }
    }

    private async Task CreateNewTag()
    {
        if (string.IsNullOrWhiteSpace(tagAutocomplete?.Text))
            return;

        try
        {
            var newTag = await TagService.SaveAsync(tagAutocomplete.Text, "#9E9E9E");
            AllTags.Add(newTag);
            SelectedTags.Add(newTag);
            TransactionDto.TagIds.Add(newTag.Id);
            selectedTag = null;
            if (tagAutocomplete != null)
            {
                await tagAutocomplete.ResetAsync();
            }
            Snackbar.Add($"Tag '{newTag.Name}' created!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating tag: {ex.Message}", Severity.Error);
        }
    }

    private void RemoveTag(Tag tag)
    {
        SelectedTags.Remove(tag);
        TransactionDto.TagIds.Remove(tag.Id);
    }

    private async Task DeleteTag(Tag tag)
    {
        await TagService.DeleteAsync(tag.Id);
        AllTags.RemoveAll(t => t.Id == tag.Id);
        RemoveTag(tag);
        Snackbar.Add("Tag deleted successfully!", Severity.Success);
        if (tagAutocomplete != null)
        {
            await tagAutocomplete.ResetAsync();
        }
    }

    private async Task Submit()
    {
        await form.Validate();
        if (!form.IsValid)
        {
            StateHasChanged();
            return;
        }
        TransactionDto.Reoccuring = Reoccuring;
        await TransactionService.SaveAsync(TransactionDto);
        var message = TransactionId == null ? "Transaction successfully added!" : "Transaction successfully updated!";
        Snackbar.Add(message, Severity.Success);
        MudDialog.Close(DialogResult.Ok(result: true));
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task TransactionTypeChanged()
    {
        Categories = await CategoryService.GetAllAsync();
        Categories = Categories.Where(c => c.Type == TransactionDto.TransactionType).ToList();

        if (Categories.Count == 0)
        {
            TransactionDto.CategoryId = null;
            Snackbar.Add("No categories for this transaction type!", Severity.Warning);
            return;
        }

        TransactionDto.CategoryId = Categories.First().Id;
        StateHasChanged();
    }
}