@using ExpenseTrackerWebApp.Database.Models
@using ExpenseTrackerWebApp.Dtos
@using ExpenseTrackerWebApp.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject AccountService AccountService
@inject CurrentUserService CurrentUserService
@inject ISnackbar Snackbar

@if (AccountDto is not null)
{
    <MudDialog>
        <TitleContent>
            <MudText Typo="Typo.h5">
                @(AccountId == null ? "Add Account" : "Edit Account")
            </MudText>
        </TitleContent>
        <DialogContent>
            <MudGrid>
                <MudItem xs="12">
                    <MudForm @ref="form">
                        <MudTextField @bind-Value="AccountDto.Name" Label="Name" Variant="Variant.Outlined" Required="true"
                            RequiredError="Name is required!">
                        </MudTextField>
                        <MudNumericField @bind-Value="AccountDto.InitialBalance" Label="Initial Balance"
                            Variant="Variant.Outlined" Required="true" RequiredError="Initial balace is required!"
                            Format="C2" Class="mt-4">
                        </MudNumericField>
                    </MudForm>
                </MudItem>
                <MudItem xs="12" Class="d-flex justify-end gap-2 mt-6">
                    <MudButton OnClick="Cancel" Variant="Variant.Outlined">Cancel</MudButton>
                    <MudButton OnClick="Submit" Color="Color.Primary" Variant="Variant.Filled">Save</MudButton>
                </MudItem>
            </MudGrid>
        </DialogContent>
    </MudDialog>
}

@code {
    MudForm form;

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public int? AccountId { get; set; }
    private AccountDto AccountDto { get; set; }


    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        AccountDto = new AccountDto();

        var userId = CurrentUserService.GetUserId();
        if (string.IsNullOrWhiteSpace(userId))
        {
            Snackbar.Add("Server error! Please try again.", Severity.Error);
            MudDialog.Close();
            return;
        }
        AccountDto.UserId = userId;
        if (AccountId == null)
        {
            return;
        }

        var account = await AccountService.GetAsync((int)AccountId);
        if (account == null)
        {
            Snackbar.Add("Server error! Please try again.", Severity.Error);
            MudDialog.Close();
            return;
        }

        AccountDto = new AccountDto()
        {
            Id = account.Id,
            Name = account.Name,
            InitialBalance = account.InitialBalance,
            UserId = account.IdentityUserId
        };
    }

    private async Task Submit()
    {
        await form.Validate();
        if (!form.IsValid)
        {
            StateHasChanged();
            return;
        }

        await AccountService.SaveAsync(AccountDto);
        var message = AccountId == null ? "Account successfully added!" : "Account successfully updated!";
        Snackbar.Add(message, Severity.Success);
        MudDialog.Close(DialogResult.Ok(result: true));
    }

    private void Cancel() => MudDialog.Cancel();
}