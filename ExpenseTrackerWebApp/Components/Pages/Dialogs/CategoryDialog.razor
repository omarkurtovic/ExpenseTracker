@using ExpenseTrackerWebApp.Database.Models
@using ExpenseTrackerWebApp.Dtos
@using ExpenseTrackerWebApp.Services
@using Microsoft.AspNetCore.Authorization
@inject CategoryService CategoryService
@inject ICurrentUserService CurrentUserService
@inject ISnackbar Snackbar

@if (CategoryDto is not null)
{
    <MudDialog>
        <TitleContent>
            <MudText Typo="Typo.h5">
                @(CategoryId == null ? "Add Category" : "Edit Category")
            </MudText>
        </TitleContent>
        <DialogContent>
            <MudGrid>
                <MudItem xs="12">
                    <MudForm @ref="form">
                        <MudTextField @bind-Value="CategoryDto.Name" Label="Name" Variant="Variant.Outlined" Required="true"
                            RequiredError="Name is required!">
                        </MudTextField>
                        <MudSelect @bind-Value="CategoryDto.Type" Label="Type" Variant="Variant.Outlined" Required="true"
                            RequiredError="Type is required!" Class="mt-4">
                            @foreach (TransactionType? item in Enum.GetValues(typeof(TransactionType)))
                            {
                                <MudSelectItem Value="@item">@item</MudSelectItem>
                            }
                        </MudSelect>
                        <MudPaper Elevation="0" Style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                            <MudSelect @bind-Value="CategoryDto.Icon" Label="Icon" Variant="Variant.Outlined" Required="true"
                                RequiredError="Icon is required!" Class="flex-grow-1" Style="width: 100%;" FullWidth="true">
                                @foreach (string? item in CategoryService.GetDefaultCategoryIcons())
                                {
                                    <MudSelectItem Value="@item" Style="display: inline-block; width: 40px; height: 40px; padding: 8px;">
                                        <MudIcon Icon="@item" Style="@($"color:{CategoryDto.Color};")" Size="Size.Medium" />
                                    </MudSelectItem>
                                }
                            </MudSelect>
                            <MudColorPicker @bind-Text="CategoryDto.Color" Label="Color" Variant="Variant.Outlined" Required="true"
                                RequiredError="Color is required!" Style="flex-shrink: 0;">
                            </MudColorPicker>
                        </MudPaper>
                    </MudForm>
                </MudItem>
                <MudItem xs="12" Class="d-flex justify-end gap-2 mt-12">
                    <MudButton OnClick="Cancel" Variant="Variant.Outlined">Cancel</MudButton>
                    <MudButton OnClick="Submit" Color="Color.Primary" Variant="Variant.Filled">Save</MudButton>
                </MudItem>
            </MudGrid>
        </DialogContent>
    </MudDialog>
}

<style>
    .mud-dialog {
        max-width: 600px !important;  
        margin-inline: 15px;
    }
</style>


@code {
    MudForm form;

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public int? CategoryId { get; set; }

    [Parameter]
    public TransactionType? Type { get; set; }
    private CategoryDto CategoryDto { get; set; }


    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        CategoryDto = new CategoryDto();
        if (Type != null)
        {
            CategoryDto.Type = Type;
        }

        var userId = CurrentUserService.GetUserId();
        if (string.IsNullOrWhiteSpace(userId))
        {
            Snackbar.Add("Server error! Please try again.", Severity.Error);
            MudDialog.Close();
            return;
        }
        CategoryDto.UserId = userId;
        if (CategoryId == null)
        {
            return;
        }

        var category = await CategoryService.GetAsync((int)CategoryId);
        if (category == null)
        {
            Snackbar.Add("Server error! Please try again.", Severity.Error);
            MudDialog.Close();
            return;
        }

        CategoryDto = new CategoryDto()
        {
            Id = category.Id,
            Name = category.Name,
            Type = category.Type,
            UserId = category.IdentityUserId,
            Icon = category.Icon,
            Color = category.Color
        };
    }

    private async Task Submit()
    {
        await form.Validate();
        if (!form.IsValid)
        {
            StateHasChanged();
            return;
        }

        await CategoryService.SaveAsync(CategoryDto);
        var message = CategoryId == null ? "Category successfully added!" : "Category successfully updated!";
        Snackbar.Add(message, Severity.Success);
        MudDialog.Close(DialogResult.Ok(result: true));
    }

    private void Cancel() => MudDialog.Cancel();
}