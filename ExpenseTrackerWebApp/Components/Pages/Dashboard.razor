@page "/"
@using ApexCharts
@using ExpenseTrackerWebApp.Components.Pages.Dialogs
@using ExpenseTrackerWebApp.Database.Models
@using ExpenseTrackerWebApp.Dtos
@using ExpenseTrackerWebApp.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor.Extensions
@using System.Globalization
@using ExpenseTrackerWebApp.Components.MyComponents

@inject TransactionService TransactionService
@inject CategoryService CategoryService
@inject AccountService AccountService
@inject IDialogService DialogService
@inject SeedDataService SeedDataService
@inject DashboardService DashboardService

<PageTitle>Dashboard</PageTitle>

@if (loading)
{
    <div class="d-flex justify-center align-center" style="height: 80vh;">
        <MudProgressCircular Indeterminate="true" Size="MudBlazor.Size.Large" />
    </div>
}
else
{
    <MudContainer>
        <MudPaper Class="pa-6 mt-6" Elevation="0">
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="5" Class="pa-4 d-flex flex-column gap-4">
                        <MudText Typo="Typo.h6">
                            Balance
                        </MudText>
                        <AmountDisplay Balance="@dashboardSummary.Balance" FontSize="Typo.h4" />
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="5" Class="pa-4 d-flex flex-column gap-4">
                        <MudText Typo="Typo.h6">
                            Income this month
                        </MudText>
                        <MudText Typo="Typo.h4" Color="MudBlazor.Color.Success">
                            @dashboardSummary.IncomeThisMonth.ToString(format: "C2")
                        </MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="5" Class="pa-4 d-flex flex-column gap-4">
                        <MudText Typo="Typo.h6">
                            Expenses this month
                        </MudText>
                        <MudText Typo="Typo.h4" Color="MudBlazor.Color.Error">
                            @dashboardSummary.ExpensesThisMonth.ToString(format: "C2")
                        </MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="6" Class="d-flex">
                    <MudPaper Elevation="5" Class="pa-4 flex-grow-1">
                        <MudText Typo="Typo.h6">
                            Expenses and Income last 6 months
                        </MudText>
                        <ApexChart TItem="CumulativeData">

                            <ApexPointSeries TItem="CumulativeData" Items="dashboardSummary.CumulativeIncomePerMonth" Name="Income"
                                XValue="@(e => e.TimePeriod)" YValue="@(e => e.Amount)"
                                SeriesType="SeriesType.Bar" />

                            <ApexPointSeries TItem="CumulativeData" Items="dashboardSummary.CumulativeExpensesPerMonth" Name="Expenses"
                                XValue="@(e => e.TimePeriod)" YValue="@(e => e.Amount)"
                                SeriesType="SeriesType.Bar" />
                        </ApexChart>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="6" Class="d-flex">
                    <MudPaper Elevation="5" Class="pa-4 flex-grow-1">
                        <MudText Typo="Typo.h6">
                            Top Expenses last 6 months
                        </MudText>
                        <ApexChart TItem="CategoryData">
                            <ApexPointSeries TItem="CategoryData" Items="dashboardSummary.TopExpenseCategories" SeriesType="SeriesType.Donut"
                                Name="Top Expenses by Category" XValue="@(e => e.Category)" YValue="@(e => e.Amount)">
                            </ApexPointSeries>
                        </ApexChart>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12">
                    <MudPaper Elevation="5" Class="pa-4">
                        <MudText Typo="Typo.h6">
                            Latest transactions
                        </MudText>
                        <MudDataGrid T="Transaction" Items="@dashboardSummary.RecentTransactions" Class="mt-4">
                            <Columns>
                                <TemplateColumn Title="Account">
                                    <CellTemplate>
                                        <MudPaper Elevation="0" Class="d-flex gap-2 align-center">
                                            <AccountName account="@context.Item.Account"></AccountName>
                                        </MudPaper>
                                    </CellTemplate>
                                </TemplateColumn>
                                <TemplateColumn Title="Category">
                                    <CellTemplate>
                                        <CategoryName category="@context.Item.Category"></CategoryName>
                                    </CellTemplate>
                                </TemplateColumn>
                                <PropertyColumn Property="t => t.Date" Format="dd/MM/yyyy" Title="Date"></PropertyColumn>
                                <TemplateColumn Title="Amount">
                                    <CellTemplate>
                                        <AmountDisplay Balance="context.Item.Amount" />
                                    </CellTemplate>
                                </TemplateColumn>
                            </Columns>
                        </MudDataGrid>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudContainer>

    <DynamicContent>
    <MobileContent>
        <AddTransactionFab OnClose="@(() => RefreshPage(false))" />
    </MobileContent></DynamicContent>
}
@code {

    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }
    private string username = "";
    bool loading = true;
    private DashboardSummary dashboardSummary = new DashboardSummary();
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        dashboardSummary = await DashboardService.GetDashboardSummaryAsync();
        loading = false;
    }

    private async Task RefreshPage(bool showMessage = false){
        loading = true;
        StateHasChanged();
        dashboardSummary = await DashboardService.GetDashboardSummaryAsync();
        loading = false;
    }
}