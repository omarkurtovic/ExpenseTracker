@page "/transactions"
@using ExpenseTrackerWebApp.Components.MyComponents
@using ExpenseTrackerWebApp.Components.Pages.Dialogs
@using ExpenseTrackerWebApp.Database.Models
@using ExpenseTrackerWebApp.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Identity.Client
@using MudBlazor.Extensions
@using System.Globalization
@inject TransactionService TransactionService
@inject CategoryService CategoryService
@inject AccountService AccountService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject SeedDataService SeedDataService

<PageTitle>Transactions</PageTitle>


@if (loading)
{
    <div class="d-flex justify-center align-center" style="height: 80vh;">
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    </div>
}
else
{
    <MudContainer MaxWidth="MaxWidth.Medium">
        <MudPaper Class="pa-6 mt-6" Elevation="15">
                <MudGrid>
                    <MudItem xs="12" Class="d-flex justify-center">
                        <MudText Typo="Typo.h4">Transactions</MudText>
                    </MudItem>
                    <MudItem xs="12" Class="d-flex justify-space-between gap-5 mb-4 ">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                            OnClick="@(() => OpenTransactionDialogAsync(null))" StartIcon="@Icons.Material.Filled.Add">Add
                        </MudButton>
                        <MudPaper Elevation="0" Class="d-flex gap-2">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@OpenExportDialog"
                                StartIcon="@Icons.Material.Filled.ImportExport">Export</MudButton>
                            @if (!string.IsNullOrWhiteSpace(username) && username.ToLower() == "sa")
                            {
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@AddTestData"
                                    StartIcon="@Icons.Material.Filled.Add">Add Test Data
                                </MudButton>
                            }
                        </MudPaper>

                    </MudItem>
                    <MudItem xs="12" md="5">
                        <MudPaper Elevation="0" Class="d-flex gap-5">
                            <MudSelect T="Account" Label="Account"  @bind-SelectedValues="selectedAccountsFilter" MultiSelectionTextFunc="@(new Func<List<string>, string>(GetAccountsMultiSelectionText))"
                                @bind-SelectedValues:after="this.FilterChanged" MultiSelection="true" Clearable="true" FullWidth="true">
                                @if (MyAccounts is not null)
                                {
                                    @foreach (var account in MyAccounts)
                                    {
                                        <MudSelectItem Value="@(account)">@account.Name</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                            <MudSelect T="DateFilterPreset ?" Label="Date" @bind-Value="dateFilter"
                                @bind-Value:after="this.FilterChanged" FullWidth="true" Clearable="true">
                                <MudSelectItem Value="@((DateFilterPreset?)DateFilterPreset.ThisMonth)">This Month
                                </MudSelectItem>
                                <MudSelectItem Value="@((DateFilterPreset?)DateFilterPreset.LastMonth)">Last Month
                                </MudSelectItem>
                                <MudSelectItem Value="@((DateFilterPreset?)DateFilterPreset.Last3Months)">Last Three Months
                                </MudSelectItem>
                                <MudSelectItem Value="@((DateFilterPreset?)DateFilterPreset.ThisYear)">This Year</MudSelectItem>
                            </MudSelect>
                            
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" md="5">
                        <MudPaper Elevation="0" Class="d-flex gap-5">
                            <MudSelect T="TransactionType ?" Label="Type" @bind-Value="transactionTypeFilter"
                                @bind-Value:after="this.FilterChanged" Clearable="true" FullWidth="true">
                                @foreach (TransactionType item in Enum.GetValues(typeof(TransactionType)))
                                {
                                    <MudSelectItem Value="@((TransactionType?)item)">@item</MudSelectItem>
                                }
                            </MudSelect>
                            <MudSelect T="Category" Label="Category" @bind-SelectedValues="selectedCategoriesFilter" MultiSelectionTextFunc="@(new Func<List<string>, string>(GetCategoriesMultiSelectionText))"
                                @bind-SelectedValues:after="this.FilterChanged"  MultiSelection="true" Clearable="true" FullWidth="true">
                                @if (MyCategories is not null)
                                {
                                    @foreach (var category in MyCategories)
                                    {
                                        <MudSelectItem Value="@(category)">@category.Name</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" md="2" Class="d-flex justify-center align-end">
                        <MudButton Variant="Variant.Outlined" OnClick="@ClearFilters" Disabled="@(!AreAnyFiltersActive())"
                            StartIcon="@Icons.Material.Filled.FilterListOff">Clear
                        </MudButton>
                    </MudItem>
                    @if (MyTransactions == null || MyTransactions.Count == 0)
                    {
                        <MudItem xs="12" Class="d-flex justify-center mt-4">
                            @if (AreAnyFiltersActive())
                            {
                                <MudText Typo="Typo.h5">No transactions found!</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.h5">No transactions created yet!</MudText>
                            }
                        </MudItem>
                    }
                    else
                    {
                        <MudItem xs="12" Class="mt-4">
                            <MudPaper Outlined="true" Elevation="1" Class="border-2">
                                <MudDataGrid T="Transaction" Items="@MyTransactions" Virtualize="true" Height="700px">
                                    <Columns>
                                    <PropertyColumn Property="t => t.Account.Name" Title="Account"></PropertyColumn>
                                        <PropertyColumn Property="t => t.Category.Name" Title="Category"></PropertyColumn>
                                        <PropertyColumn Property="t => t.Date" Format="dd//MM/yyyy" Title="Date"></PropertyColumn>
                                        <TemplateColumn Title="Amount" SortBy="t => t.Amount" Sortable="true">
                                            <CellTemplate>
                                                <AmountDisplay Balance="context.Item.Amount" />
                                            </CellTemplate>
                                        </TemplateColumn>
                                        <TemplateColumn>
                                            <CellTemplate>
                                                <MudPaper Elevation="0" Class="d-flex gap-4">
                                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary"
                                                        OnClick="@(() => OpenTransactionDialogAsync(context.Item.Id))">
                                                    </MudIconButton>
                                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                                        OnClick="@(() => ConfirmDelete(context.Item.Id))"></MudIconButton>
                                                </MudPaper>
                                            </CellTemplate>
                                        </TemplateColumn>
                                    </Columns>
                                </MudDataGrid>
                                <MudItem xs="12" Class="pa-6 pl-0">
                                    @{
                                        var balance = MyTransactions.Sum(t => t.Amount);
                                    }
                                    <MudPaper Elevation="0" Class="d-flex gap-2">
                                        <MudText>
                                            Balance: <AmountDisplay Balance="balance" />
                                        </MudText>
                                    </MudPaper>

                                </MudItem>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>

            @* } *@
        </MudPaper>
    </MudContainer>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }

    private string username = "";
    private List<Transaction> MyTransactions;
    private List<Category> MyCategories;
    private List<Account> MyAccounts;
    private TransactionType? transactionTypeFilter;
    private DateFilterPreset? dateFilter;

    private IEnumerable<Account> selectedAccountsFilter { get; set; }
    private IEnumerable<Category> selectedCategoriesFilter { get; set; }

    private bool AreAnyFiltersActive()
    {
        return transactionTypeFilter != null
        || (selectedCategoriesFilter != null && selectedCategoriesFilter.Count() != 0)
        || dateFilter != null
        || (selectedAccountsFilter != null && selectedAccountsFilter.Count() != 0);
    }

    private void ClearFilters(){
        
        transactionTypeFilter = null;
        selectedCategoriesFilter = new HashSet<Category>() { };
        selectedAccountsFilter = new HashSet<Account>() { };
        dateFilter = null;
    }

    bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        MyTransactions = await TransactionService.GetAllAsync();
        MyCategories = await CategoryService.GetAllAsync();
        MyAccounts = await AccountService.GetAllAsync();

        ClearFilters();

        if (authenticationState is not null)
        {
            var authState = await authenticationState;
            var user = authState?.User;

            if (user?.Identity is not null && user.Identity.IsAuthenticated)
            {
                username = user.Identity.Name ?? "";
            }
        }
        
        loading = false;
    }

    private async Task OpenTransactionDialogAsync(int? transaction_id)
    {
        if ((await CategoryService.GetAllAsync()).Count == 0)
        {
            Snackbar.Add("No categories found! Create some then try again!", Severity.Error);
            return;
        }

        if ((await AccountService.GetAllAsync()).Count == 0)
        {
            Snackbar.Add("No accounts found! Create some then try again!", Severity.Error);
            return;
        }

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            NoHeader = false,
            CloseButton = true,
            MaxWidth = MaxWidth.Medium
        };
        var parameters = new DialogParameters<TransactionDialog>
{
{ x => x.TransactionId, transaction_id }
};

        var dialog = await DialogService.ShowAsync<TransactionDialog>(title: "Simple Dialog", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await RefreshPage();
        }
    }

    private async Task ConfirmDelete(int transaction_id)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.Message, "Are you sure you want to delete the transaction? " }
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>(title: "Warning", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await TransactionService.DeleteAsync(transaction_id);
            Snackbar.Add("Transaction succesfully deleted! ", Severity.Success);
            await RefreshPage();
        }
    }


    private async Task FilterChanged()
    {
        await RefreshPage();
        StateHasChanged();
    }

    private string GetAccountsMultiSelectionText(List<string> selectedAccounts){
        return string.Join(", ", selectedAccounts);
    }

    private string GetCategoriesMultiSelectionText(List<string> selectedCategories){
        return string.Join(", ", selectedCategories);
    }

    async Task RefreshPage()
    {

        MyTransactions = await TransactionService.GetAllAsync();
        MyCategories = await CategoryService.GetAllAsync();
        MyAccounts = await AccountService.GetAllAsync();

        if (transactionTypeFilter is not null)
        {
            MyTransactions = MyTransactions.Where(t => t.Category.Type == transactionTypeFilter).ToList();
            MyCategories = MyCategories.Where(c => c.Type == transactionTypeFilter).ToList();
            selectedCategoriesFilter = selectedCategoriesFilter.Where(c => c.Type == transactionTypeFilter).ToList();
        }

        if (selectedAccountsFilter is not null && selectedAccountsFilter.Count() != 0)
        {
            var accountIds = selectedAccountsFilter.Select(a => a.Id).ToList();
            MyTransactions = MyTransactions.Where(t => accountIds.Contains(t.AccountId)).ToList();
        }

        if (selectedCategoriesFilter is not null && selectedCategoriesFilter.Count() != 0)
        {
            var categoryIds = selectedCategoriesFilter.Select(a => a.Id).ToList();
            MyTransactions = MyTransactions.Where(t => categoryIds.Contains(t.CategoryId)).ToList();
        }

        if (dateFilter is not null)
        {
            switch (dateFilter)
            {
                case DateFilterPreset.ThisMonth:
                    var startOfMonth = DateTime.Now.StartOfMonth(CultureInfo.CurrentCulture);
                    MyTransactions = MyTransactions.Where(t => t.Date >= startOfMonth).ToList();
                    break;

                case DateFilterPreset.LastMonth:
                    DateTime oneMonthAgo = DateTime.Now.AddMonths(-1);
                    DateTime startOfLastMonth = oneMonthAgo.StartOfMonth(CultureInfo.CurrentCulture);
                    DateTime endOfLastMonth = oneMonthAgo.EndOfMonth(CultureInfo.CurrentCulture);
                    MyTransactions = MyTransactions.Where(t => t.Date >= startOfLastMonth && t.Date < endOfLastMonth).ToList();
                    break;

                case DateFilterPreset.Last3Months:
                    DateTime threeMonthsAgo = DateTime.Now.AddMonths(-3);
                    DateTime startOf3MonthsAgoMonth = threeMonthsAgo.StartOfMonth(CultureInfo.CurrentCulture);
                    MyTransactions = MyTransactions.Where(t => t.Date >= startOf3MonthsAgoMonth).ToList();
                    break;


                case DateFilterPreset.ThisYear:
                    var startOfyear = new DateTime(DateTime.Now.Year, 1, 1);
                    MyTransactions = MyTransactions.Where(t => t.Date >= startOfyear).ToList();
                    break;

            }
        }
    }

    public enum DateFilterPreset
    {
        ThisMonth,
        LastMonth,
        Last3Months,
        ThisYear
    }


    private async Task AddTestData()
    {
        await SeedDataService.SeedDummyDataAsync();
        await RefreshPage();
        StateHasChanged();
    }

    private async Task OpenExportDialog()
    {

        var transactions = await TransactionService.GetAllAsync();
        if (transactions.Count == 0)
        {
            Snackbar.Add("No transactions to export!", Severity.Error);
            return;
        }

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            NoHeader = false,
            CloseButton = true,
            MaxWidth = MaxWidth.Medium
        };

        var parameters = new DialogParameters<ExportDialog>
        {
        };

        var dialog = await DialogService.ShowAsync<ExportDialog>(title: "", parameters, options);
    }
}

}