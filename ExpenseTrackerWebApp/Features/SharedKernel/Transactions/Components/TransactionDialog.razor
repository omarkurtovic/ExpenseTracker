@using ExpenseTrackerWebApp.Database.Models
@using ExpenseTrackerWebApp.Features.SharedKernel.Components
@using ExpenseTrackerWebApp.Features.SharedKernel.Transactions.Commands
@using ExpenseTrackerWebApp.Features.SharedKernel.Transactions.Queries
@using ExpenseTrackerWebApp.Features.SharedKernel.Queries
@using MediatR
@using MudBlazor
@using ExpenseTrackerWebApp.Features.SharedKernel.Transactions.Dtos
@using ExpenseTrackerWebApp.Services

@inject ISnackbar Snackbar
@inject ISender Mediator   
@inject ICurrentUserService CurrentUserService
@inject TagService TagService 

@if (TransactionDto is not null)
{
    <MudDialog>
        <TitleContent>
            <MudText Typo="Typo.h5">
                @(TransactionId == null ? "Add Transaction" : "Edit Transaction")
            </MudText>
        </TitleContent>
        <DialogContent>
            <MudGrid>
                <MudItem xs="12">
                    <MudForm @ref="form">
                        @if (Reoccuring)
                        {
                            <MudAlert Severity="Severity.Info" Elevation="0" Variant="Variant.Filled" Class="mb-4">
                                You are adding a reoccuring transaction. This transaction will be repeated based on the
                                reoccuring settings.
                            </MudAlert>


                            <MudSelect @bind-Value="TransactionDto.ReoccuranceFrequency" Label="Reoccurance type"
                                Variant="Variant.Outlined" Required="true" RequiredError="Reoccurance type is required!"
                                @bind-Value:after="this.TransactionTypeChanged">
                                @foreach (ReoccuranceFrequency? item in Enum.GetValues(typeof(ReoccuranceFrequency)))
                                {
                                    <MudSelectItem Value="@((ReoccuranceFrequency?)item)">@item</MudSelectItem>
                                }
                            </MudSelect>
                        }
                        <MudSelect @bind-Value="TransactionDto.AccountId" Label="Account" Variant="Variant.Outlined"
                            Required="true" RequiredError="Account is required!">
                            @foreach (var account in AllAccounts)
                            {
                                <MudSelectItem Value="@((int?)account.Id)">
                                    <TextWithIcon Text="@account.Name" Icon="@account.Icon" IconColor="@account.Color" IconSize="Size.Small" TextTypo="Typo.body2"></TextWithIcon>
                                </MudSelectItem>
                            }
                        </MudSelect>
                        <MudSelect @bind-Value="TransactionDto.TransactionType" Label="Type" Variant="Variant.Outlined"
                            Required="true" RequiredError="Type of transaction is required!"
                            @bind-Value:after="this.TransactionTypeChanged">
                            @foreach (TransactionType? item in Enum.GetValues(typeof(TransactionType)))
                            {
                                <MudSelectItem Value="@((TransactionType?)item)">@item</MudSelectItem>
                            }
                        </MudSelect>
                        <MudSelect @bind-Value="TransactionDto.CategoryId" Label="Category" Variant="Variant.Outlined"
                            Required="true" RequiredError="Category is required!">
                            @foreach (var category in AllCategories)
                            {
                                <MudSelectItem Value="@((int?)category.Id)">
                                    <TextWithIcon Text="@category.Name" Icon="@category.Icon" IconColor="@category.Color" IconSize="Size.Small" TextTypo="Typo.body2"></TextWithIcon>
                                </MudSelectItem>
                            }
                        </MudSelect>

                        <MudNumericField @bind-Value="TransactionDto.Amount" Label="Amount" Variant="Variant.Outlined"
                            Required="true" RequiredError="Amount is required!" Format="F2">
                        </MudNumericField>
                        <MudPaper Elevation="0" Class="d-flex gap-2">
                            <MudDatePicker @bind-Date="TransactionDto.Date" Label="Date" Variant="Variant.Outlined"
                                Required="true" RequiredError="Date is required!" />

                            <MudTimePicker @bind-Time="TransactionDto.Time" Label="Time" Variant="Variant.Outlined"
                                AmPm="true" Required="true" RequiredError="Time is required!" />
                        </MudPaper>

                        <MudTextField @bind-Value="TransactionDto.Description" Label="Description"
                            Variant="Variant.Outlined">
                        </MudTextField>

                        <MudPaper Elevation="0" Class="d-flex gap-2 mt-4">
                            <MudAutocomplete T="Tag" @ref="tagAutocomplete" SearchFunc="@TagSearchFunc"
                                ToStringFunc="@(e => e == null ? null : e.Name)" Label="Add Tags" Variant="Variant.Outlined"
                                ValueChanged="@OnTagSelected" Clearable="true" Class="flex-grow-1">
                                <ItemTemplate>
                                    <MudPaper Elevation="0" Class="d-flex gap-2">
                                        @if (!string.IsNullOrEmpty(context?.Color))
                                        {
                                            <MudPaper Elevation="0" Class="d-flex gap-2">

                                                <MudChip T="Tag" Style="@($"background-color:{context.Color}; color:white;")"
                                                    Size="Size.Small">@context.Name</MudChip>

                                                <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small"
                                                    Color="Color.Inherit" Style="color:white;"
                                                    OnClick="@(() => DeleteTag(context))"></MudIconButton>
                                            </MudPaper>
                                        }
                                        else
                                        {
                                            <MudText>@context?.Name</MudText>
                                        }
                                    </MudPaper>
                                </ItemTemplate>
                                <NoItemsTemplate>
                                    <MudText Align="Align.Center" Class="px-4 py-1">
                                        <span>No tags found </span>
                                        @if (!string.IsNullOrWhiteSpace(tagAutocomplete?.Text))
                                        {
                                            <MudPaper Elevation="0" Class="d-flex justify-center mt-2">
                                                <MudButton Variant="Variant.Outlined" OnClick="@CreateNewTag"
                                                    StartIcon="@Icons.Material.Filled.Add">
                                                    Create new tag: <strong>@tagAutocomplete.Text</strong>
                                                </MudButton>
                                            </MudPaper>
                                        }

                                    </MudText>
                                </NoItemsTemplate>
                            </MudAutocomplete>
                        </MudPaper>

                        <MudPaper Elevation="0" Class="d-flex gap-2 mt-2 flex-wrap">
                            @foreach (var tag in SelectedTags)
                            {
                                <MudPaper Elevation="0" Class="flex gap-2">
                                    <MudChip T="Tag" Style="@($"background-color:{tag.Color}; color:white;")"
                                        Size="Size.Medium">
                                        <MudText Typo="Typo.body2">@tag.Name</MudText>
                                        <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small"
                                            Color="Color.Inherit" Style="color:white;" OnClick="@(() => RemoveTag(tag))">
                                        </MudIconButton>
                                    </MudChip>
                                </MudPaper>
                            }
                        </MudPaper>

                    </MudForm>
                </MudItem>
                <MudItem xs="12" Class="d-flex justify-end gap-2 mt-6">
                    <MudButton OnClick="Cancel" Variant="Variant.Outlined">Cancel</MudButton>
                    <MudButton OnClick="Submit" Color="Color.Primary" Variant="Variant.Filled">Save</MudButton>
                </MudItem>
            </MudGrid>

        </DialogContent>
    </MudDialog>
}
<style>
    .mud-dialog {
        max-width: 600px !important;
        margin-inline: 15px;
    }
</style>

@code {
    [Parameter]
    public int? TransactionId { get; set; }
    [Parameter]
    public bool Reoccuring { get; set; }

    [CascadingParameter]
    public required IMudDialogInstance MudDialog { get; set; }


    private MudForm form = new();
    private MudAutocomplete<Tag>? tagAutocomplete;
    private Tag? selectedTag;
    private List<Tag> SelectedTags = new();
    private TransactionDto TransactionDto = new();

    private List<Tag> AllTags = new();
    private List<Category> AllCategories = new();
    private List<Account> AllAccounts = new();

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        AllCategories = await Mediator.Send(new GetCategoriesQuery() { UserId = CurrentUserService.GetUserId() });
        if (AllCategories.Count == 0)
        {
            Snackbar.Add("No categories found! Create some then try again!", Severity.Error);
            MudDialog.Close();
            return;
        }

        AllAccounts = await Mediator.Send(new GetAccountsQuery() { UserId = CurrentUserService.GetUserId() });
        if (AllAccounts.Count == 0)
        {
            Snackbar.Add("No accounts found! Create some then try again!", Severity.Error);
            MudDialog.Close();
            return;
        }

        AllTags = await Mediator.Send(new GetTagsQuery() { UserId = CurrentUserService.GetUserId() });

        TransactionDto = GetDefaultTransaction(AllAccounts, AllCategories, Reoccuring);
        if (TransactionId != null)
        {
            try{
                TransactionDto = await Mediator.Send(new GetTransactionQuery() { UserId = CurrentUserService.GetUserId(), Id = (int)TransactionId });
                TransactionDto.Amount = Math.Abs((decimal)TransactionDto.Amount!);
                SelectedTags = AllTags.Where(t => TransactionDto.TagIds.Contains(t.Id)).ToList();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error getting transaction: {ex.Message}");
                Snackbar.Add($"Error getting transaction!", Severity.Error);
                MudDialog.Close();
                return;
            }
        }

        AllCategories = AllCategories.Where(c => c.Type == TransactionDto.TransactionType).ToList();
    }

    private async Task<IEnumerable<Tag>> TagSearchFunc(string searchText, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            var results = new List<Tag>(AllTags);
            results.RemoveAll(t => SelectedTags.Any(st => st.Id == t.Id));
            return results;
        }

        var filteredTags = AllTags
        .Where(t => t.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase))
        .Where(t => !SelectedTags.Any(st => st.Id == t.Id))
        .ToList();

        return await Task.FromResult(filteredTags);
    }

    private async Task OnTagSelected(Tag tag)
    {
        if (tag != null && !SelectedTags.Any(t => t.Id == tag.Id))
        {
            SelectedTags.Add(tag);
            TransactionDto.TagIds.Add(tag.Id);
            selectedTag = null;
            if (tagAutocomplete != null)
            {
                await tagAutocomplete.ResetAsync();
            }
        }
    }

    private async Task CreateNewTag()
    {
        if (string.IsNullOrWhiteSpace(tagAutocomplete?.Text))
            return;

        try
        {
            var newTag = await TagService.SaveAsync(tagAutocomplete.Text, "#9E9E9E");
            AllTags.Add(newTag);
            SelectedTags.Add(newTag);
            TransactionDto.TagIds.Add(newTag.Id);
            selectedTag = null;
            if (tagAutocomplete != null)
            {
                await tagAutocomplete.ResetAsync();
            }
            Snackbar.Add($"Tag '{newTag.Name}' created!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating tag: {ex.Message}", Severity.Error);
        }
    }

    private void RemoveTag(Tag tag)
    {
        SelectedTags.Remove(tag);
        TransactionDto.TagIds.Remove(tag.Id);
    }

    private async Task DeleteTag(Tag tag)
    {
        await TagService.DeleteAsync(tag.Id);
        AllTags.RemoveAll(t => t.Id == tag.Id);
        RemoveTag(tag);
        Snackbar.Add("Tag deleted successfully!", Severity.Success);
        if (tagAutocomplete != null)
        {
            await tagAutocomplete.ResetAsync();
        }
    }

    private async Task Submit()
    {
        await form.Validate();
        if (!form.IsValid)
        {
            StateHasChanged();
            return;
        }
        TransactionDto.IsReoccuring = Reoccuring;
        TransactionDto.TagIds = SelectedTags.Select(t => t.Id).ToList();
        if(TransactionDto.Date != null){
            TransactionDto.Date = new DateTime(TransactionDto.Date.Value.Year, TransactionDto.Date.Value.Month, TransactionDto.Date.Value.Day,0, 0, 0);
        }

        try{
            if(TransactionId == null){
                await Mediator.Send(new CreateTransactionCommand() { TransactionDto = TransactionDto, UserId = CurrentUserService.GetUserId() });
            }
            else{
                await Mediator.Send(new EditTransactionCommand() { Id = (int)TransactionId, TransactionDto = TransactionDto, UserId = CurrentUserService.GetUserId() });
            }
            
            var message = TransactionId == null ? "Transaction successfully added!" : "Transaction successfully updated!";
            Snackbar.Add(message, MudBlazor.Severity.Success);
            NewTransaction();
        }
        catch(FluentValidation.ValidationException vex){
            var errors = string.Join(", ", vex.Errors.Select(e => e.ErrorMessage));
            Snackbar.Add($"Validation error: {errors}!", MudBlazor.Severity.Error);
        }
        catch(Exception ex){
            Console.WriteLine($"Error saving transaction: {ex.Message}");
            Snackbar.Add($"Server error!", MudBlazor.Severity.Error);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task TransactionTypeChanged()
    {
        AllCategories = await Mediator.Send(new GetCategoriesQuery() { UserId = CurrentUserService.GetUserId()  });
        AllCategories = AllCategories.Where(c => c.Type == TransactionDto.TransactionType).ToList();

        if (AllCategories.Count == 0)
        {
            TransactionDto.CategoryId = null;
            Snackbar.Add("No categories for this transaction type!", Severity.Warning);
            return;
        }

        TransactionDto.CategoryId = AllCategories.First().Id;
        StateHasChanged();
    }


    private TransactionDto GetDefaultTransaction(List<Account> accounts, List<Category> categories, bool reoccuring)
    {
        var result = new TransactionDto();
        result.AccountId = accounts.First().Id;
        result.CategoryId = categories.First().Id;
        result.TransactionType = categories.First().Type;
        result.Date = DateTime.Now.Date;
        result.Time = DateTime.Now.TimeOfDay;
        result.Amount = 0;
        SelectedTags = new();
        result.IsReoccuring = reoccuring;
        return result;
    }

    private void NewTransaction(){
        TransactionDto = GetDefaultTransaction(AllAccounts, AllCategories, Reoccuring);
        SelectedTags = new();
        TransactionId = null;
    }
    
}