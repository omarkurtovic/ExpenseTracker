
@attribute [AllowAnonymous]
@page "/login"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Login</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" >
    <MudPaper Class="pa-6 mt-6" Elevation="15">
        <MudForm @ref="form">
            <MudGrid>
                <MudItem xs="12" Class="d-flex justify-center">
                    <MudText Typo="Typo.h4">Welcome back!</MudText>
                </MudItem>
                <MudItem xs="12">
                        <MudTextField @bind-Value="email" Label="Email" Variant="Variant.Text"
                            Required="true" RequiredError="Email is required!">
                        </MudTextField>
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="password" Label="Password"
                    Required="true" RequiredError="Password is required!"
                        Variant="Variant.Text" InputType="@PasswordInput"
                        Adornment="Adornment.End" AdornmentIcon="@PasswordInputIcon"
                        OnAdornmentClick="ShowPasswordClick" AdornmentAriaLabel="Show Password" />

                </MudItem>
                <MudItem xs="12" Class="d-flex justify-center">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@BtnLogin_Click" Class="px-20 py-1">Login</MudButton>
                </MudItem>
                @if(error){
                    <MudItem xs="12" Class="d-flex justify-center">
                        <MudAlert Severity="Severity.Error">Login failed, please try again.</MudAlert>
                    </MudItem>
                }
                <MudItem xs="12" Class="d-flex justify-center mt-10">
                    <MudText Typo="Typo.body1">Dont't have an account? Register <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="BtnRegister_Click">HERE</MudButton></MudText>
                </MudItem>
            </MudGrid>
        </MudForm>
    </MudPaper>
</MudContainer>
    
    

@code{

    [SupplyParameterFromQuery]
    [Parameter]
    public bool error {get; set;} = false;

    [SupplyParameterFromQuery]
    [Parameter]
    public string email {get; set;} = "";

    public string password {get; set;} = "";

    private MudForm form;
    private bool isShow;
    private InputType PasswordInput = InputType.Password;
    private string PasswordInputIcon = Icons.Material.Filled.VisibilityOff;

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        if (error)
        {
            Snackbar.Add("Login failed! Please try again.", Severity.Error);
            error = false;
        }
    }
    private async Task BtnLogin_Click(){
        
        await form.Validate();
        if (!form.IsValid)
        {
            return;
        }

        HandleLogin();
    }
    
    private void HandleLogin()
    {
        NavigationManager.NavigateTo($"/api/auth/login?email={email}&password={password}", forceLoad: true);
    }

    private void BtnRegister_Click(){
        NavigationManager.NavigateTo("Register");
    }
    
    private void ShowPasswordClick()
    {
        @if (isShow)
        {
            isShow = false;
            PasswordInputIcon = Icons.Material.Filled.VisibilityOff;
            PasswordInput = InputType.Password;
        }
        else {
            isShow = true;
            PasswordInputIcon = Icons.Material.Filled.Visibility;
            PasswordInput = InputType.Text;
        }
    }
}