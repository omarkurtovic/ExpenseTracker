@using ExpenseTrackerWebApp.Components.Pages
@using ExpenseTrackerWebApp.Database.Models
@using ExpenseTrackerWebApp.Dtos
@using ExpenseTrackerWebApp.Features.Budgets.Commands
@using ExpenseTrackerWebApp.Features.Budgets.Dtos
@using ExpenseTrackerWebApp.Features.Budgets.Queries
@using ExpenseTrackerWebApp.Features.SharedKernel.Queries
@using ExpenseTrackerWebApp.Services
@using MediatR
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using ExpenseTrackerWebApp.Components.MyComponents
@inject ICurrentUserService CurrentUserService
@inject ISnackbar Snackbar
@inject ISender Mediator

@if (BudgetDto is not null)
{
    <MudDialog>
        <TitleContent>
            <MudText Typo="Typo.h5">
                @(BudgetDto == null ? "Add Budget" : "Edit Budget")
            </MudText>
        </TitleContent>
        <DialogContent>
            <MudGrid>
                <MudItem xs="12">
                    <MudForm @ref="form">
                        <MudTextField @bind-Value="BudgetDto.Name" Label="Name" Variant="Variant.Outlined" Required="true"
                            RequiredError="Name is required!">
                        </MudTextField>
                        <MudSelect @bind-Value="BudgetDto.BudgetType" Label="Type" Variant="Variant.Outlined"
                            Required="true" RequiredError="Budget type is required!">
                            @foreach (BudgetType? item in Enum.GetValues(typeof(BudgetType)))
                            {
                                <MudSelectItem Value="@((BudgetType?)item)">@item</MudSelectItem>
                            }
                        </MudSelect>
                        <MudNumericField @bind-Value="BudgetDto.Amount" Label="Amount"
                            Variant="Variant.Outlined" Required="true" RequiredError="Amount is required!"
                            Format="C2" Class="mt-4">
                        </MudNumericField>
                        <MudTextField @bind-Value="BudgetDto.Description" Label="Description" Variant="Variant.Outlined">
                        </MudTextField>
                        <MudSelect T="int" Label="Categories" @bind-SelectedValues="BudgetDto.Categories"
                            MultiSelectionTextFunc="@(new Func<List<string>, string>(GetCategoryMultiSelectionText))"
                            MultiSelection="true" Clearable="true" FullWidth="true" 
                            Required="true" RequiredError="At least one category is required!">
                            @foreach (var category in Categories)
                            {
                                <MudSelectItem Value="@(category.Id)">
                                    <MudPaper Elevation="0" Class="d-flex gap-3 align-end" Style="background: transparent;">
                                        <MudIcon Icon="@category.Icon" Style="@($"color: {category.Color};")" Size="Size.Small" />
                                        <MudText Typo="Typo.body2">@category.Name</MudText>
                                    </MudPaper>
                                </MudSelectItem>
                            }
                        </MudSelect>
                        <MudSelect T="int" Label="Accounts" @bind-SelectedValues="BudgetDto.Accounts"
                            MultiSelectionTextFunc="@(new Func<List<string>, string>(GetAccountMultiSelectionText))"
                            MultiSelection="true" Clearable="true" FullWidth="true" 
                            Required="true" RequiredError="At least one account is required!">
                            @foreach (var account in Accounts)
                            {
                                <MudSelectItem Value="@(account.Id)">
                                    <MudPaper Elevation="0" Class="d-flex gap-3 align-end" Style="background: transparent;">
                                        @if (!string.IsNullOrEmpty(account.Icon))
                                        {
                                            <MudIcon Icon="@(account.Icon)" Style="@($"color: {account.Color};")" Size="Size.Small" />
                                        }
                                        <MudText Typo="Typo.body2">@account.Name</MudText>
                                    </MudPaper>
                                </MudSelectItem>
                            }
                        </MudSelect>
                    </MudForm>
                </MudItem>
                <MudItem xs="12" Class="d-flex justify-end gap-2 mt-12">
                    <MudButton OnClick="Cancel" Variant="Variant.Outlined">Cancel</MudButton>
                    <MudButton OnClick="Submit" Color="Color.Primary" Variant="Variant.Filled">Save</MudButton>
                </MudItem>
            </MudGrid>
        </DialogContent>
    </MudDialog>
}

<style>
    .mud-dialog {
        max-width: 600px !important;  
        margin-inline: 15px;
    }
</style>

@code {
    MudForm form;

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public int? BudgetId { get; set; }

    [Parameter]
    public BudgetDto BudgetDto {get; set;} = new();
    public List<Category> Categories{get; set;} = new();
    public List<Account> Accounts{get; set;} = new();

    protected override async Task OnParametersSetAsync()
    {
        var userId = CurrentUserService.GetUserId();
        if (string.IsNullOrWhiteSpace(userId))
        {
            Snackbar.Add("Server error! Please try again.", Severity.Error);
            MudDialog.Close();
            return;
        }

        BudgetDto = new BudgetDto();
        Categories = await Mediator.Send(new GetCategoriesQuery(){UserId = userId});
        Accounts = await Mediator.Send(new GetAccountsQuery(){UserId = userId});

        if (BudgetId == null)
        {
            return;
        }

        
        try{
            BudgetDto = await Mediator.Send(new GetBudgetQuery() { UserId = CurrentUserService.GetUserId(), Id = (int)BudgetId });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error getting budget: {ex.Message}");
            Snackbar.Add($"Error getting budget!", MudBlazor.Severity.Error);
            MudDialog.Close();
            return;
        }
    }

    private async Task Submit()
    {
        await form.Validate();
        if (!form.IsValid)
        {
            StateHasChanged();
            return;
        }

        try{
            if(BudgetId == null){
                await Mediator.Send(new CreateBudgetCommand() { BudgetDto = BudgetDto, UserId = CurrentUserService.GetUserId() });
            }
            else{
                await Mediator.Send(new EditBudgetCommand() { Id = (int)BudgetId, BudgetDto = BudgetDto, UserId = CurrentUserService.GetUserId() });
            }
            
            var message = BudgetId == null ? "Budget successfully added!" : "Budget successfully updated!";
            Snackbar.Add(message, MudBlazor.Severity.Success);
            MudDialog.Close(DialogResult.Ok(result: true));
        }
        catch(FluentValidation.ValidationException vex){
            var errors = string.Join(", ", vex.Errors.Select(e => e.ErrorMessage));
            Snackbar.Add($"Validation error: {errors}!", MudBlazor.Severity.Error);
        }
        catch(Exception ex){
            Console.WriteLine($"Error saving category: {ex.Message}");
            Snackbar.Add($"Server error!", MudBlazor.Severity.Error);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private string GetAccountMultiSelectionText(List<string> selectedValues)
    {
        return string.Join(separator: ", ", Accounts.Where(a => selectedValues.Contains(a.Id.ToString())).Select(a => a.Name));
    }
    private string GetCategoryMultiSelectionText(List<string> selectedValues)
    {
        return string.Join(separator: ", ", Categories.Where(c => selectedValues.Contains(c.Id.ToString())).Select(c => c.Name));
    }
}