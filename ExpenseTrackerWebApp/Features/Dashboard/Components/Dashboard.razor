@page "/dashboard"
@using ExpenseTrackerWebApp.Database.Models
@using ExpenseTrackerWebApp.Features.Dashboard.Dtos
@using ExpenseTrackerWebApp.Features.Dashboard.Queries
@using ExpenseTrackerWebApp.Features.SharedKernel.Transactions.Components
@using ExpenseTrackerWebApp.Services
@using Microsoft.AspNetCore.Components.Web
@using MudBlazor
@using ExpenseTrackerWebApp.Features.SharedKernel.Components
@using ExpenseTrackerWebApp.Features.Transactions.Components
@using ApexCharts
@using MediatR
@inject ISender Mediator
@inject ICurrentUserService CurrentUserService

<PageTitle>Dashboard</PageTitle>

@if (loading)
{
    <div class="d-flex justify-center align-center" style="height: 80vh;">
        <MudProgressCircular Indeterminate="true" Size="MudBlazor.Size.Large" />
    </div>
}
else
{
    <MudContainer>
        <MudPaper Class="pa-6 mt-6" Elevation="0">
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="5" Class="pa-4 d-flex flex-column gap-4">
                        <MudText Typo="Typo.h6">
                            Balance
                        </MudText>
                        <AmountDisplay Balance="@dashboardSummary.Balance" FontSize="Typo.h4" />
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="5" Class="pa-4 d-flex flex-column gap-4">
                        <MudText Typo="Typo.h6">
                            Income this month
                        </MudText>
                        <MudText Typo="Typo.h4" Color="MudBlazor.Color.Success">
                            @dashboardSummary.IncomeThisMonth.ToString(format: "C2")
                        </MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="5" Class="pa-4 d-flex flex-column gap-4">
                        <MudText Typo="Typo.h6">
                            Expenses this month
                        </MudText>
                        <MudText Typo="Typo.h4" Color="MudBlazor.Color.Error">
                            @dashboardSummary.ExpensesThisMonth.ToString(format: "C2")
                        </MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="6" Class="d-flex">
                    <MudPaper Elevation="5" Class="pa-4 flex-grow-1">
                        <MudText Typo="Typo.h6">
                            Expenses and Income last 6 months
                        </MudText>
                        <ApexChart TItem="CumulativeData">

                            <ApexPointSeries TItem="CumulativeData" Items="dashboardSummary.CumulativeIncomePerMonth" Name="Income"
                                XValue="@(e => e.TimePeriod)" YValue="@(e => e.Amount)"
                                SeriesType="SeriesType.Bar" />

                            <ApexPointSeries TItem="CumulativeData" Items="dashboardSummary.CumulativeExpensesPerMonth" Name="Expenses"
                                XValue="@(e => e.TimePeriod)" YValue="@(e => e.Amount)"
                                SeriesType="SeriesType.Bar" />
                        </ApexChart>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="6" Class="d-flex">
                    <MudPaper Elevation="5" Class="pa-4 flex-grow-1">
                        <MudText Typo="Typo.h6">
                            Top Expenses last 6 months
                        </MudText>
                        <ApexChart TItem="CategoryData">
                            <ApexPointSeries TItem="CategoryData" Items="dashboardSummary.TopExpenseCategories" SeriesType="SeriesType.Donut"
                                Name="Top Expenses by Category" XValue="@(e => e.Category)" YValue="@(e => e.Amount)">
                            </ApexPointSeries>
                        </ApexChart>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12">
                    <MudPaper Elevation="5" Class="pa-4">
                        <MudText Typo="Typo.h6">
                            Latest transactions
                        </MudText>
                        <MudDataGrid T="Transaction" Items="@dashboardSummary.RecentTransactions" Class="mt-4">
                            <Columns>
                                <TemplateColumn Title="Account">
                                    <CellTemplate>
                                        <MudPaper Elevation="0" Class="d-flex gap-2 align-center">
                                            <TextWithIcon Text="@context.Item.Account.Name" Icon="@context.Item.Account.Icon" IconColor="@context.Item.Account.Color" IconSize="MudBlazor.Size.Small" TextTypo="Typo.body2"></TextWithIcon>
                                        </MudPaper>
                                    </CellTemplate>
                                </TemplateColumn>
                                <TemplateColumn Title="Category">
                                    <CellTemplate>
                                        <TextWithIcon Text="@context.Item.Category.Name" Icon="@context.Item.Category.Icon" IconColor="@context.Item.Category.Color" IconSize="MudBlazor.Size.Small" TextTypo="Typo.body2"></TextWithIcon>
                                    </CellTemplate>
                                </TemplateColumn>
                                <PropertyColumn Property="t => t.Date" Format="dd/MM/yyyy" Title="Date"></PropertyColumn>
                                <TemplateColumn Title="Amount">
                                    <CellTemplate>
                                        <AmountDisplay Balance="context.Item.Amount" />
                                    </CellTemplate>
                                </TemplateColumn>
                            </Columns>
                        </MudDataGrid>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudContainer>

    <DynamicContent>
        <MobileContent>
            <AddTransactionFab OnClose="@(() => RefreshPage(false))" />
        </MobileContent>
    </DynamicContent>
}
@code {

    bool loading = true;
    private DashboardSummaryDto dashboardSummary = new DashboardSummaryDto();
    protected override async Task OnInitializedAsync()
    {
        await RefreshPage();
        loading = false;
    }

    private async Task RefreshPage(bool showMessage = false){
        loading = true;
        StateHasChanged();
        dashboardSummary = await Mediator.Send(new GetDashboardSummaryQuery { UserId = CurrentUserService.GetUserId() });
        loading = false;
    }
}